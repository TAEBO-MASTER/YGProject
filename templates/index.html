<!DOCTYPE html>
<html lang="ko">
<head>
    <!-- 기본 파비콘 (fallback) -->
    <link rel="icon" href="/favicon.ico">

    <!-- 고해상도 파비콘 -->
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">

    <!-- iOS 홈화면 아이콘 -->
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">

    <!-- 브라우저 테마 컬러(모바일 주소창 색상) -->
    <meta name="theme-color" content="#1f2937">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Where2Meet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        #map {
            height: 400px; /* 지도의 높이 설정 */
            width: 100%;
            border-radius: 0.5rem; /* Tailwind rounded-lg */
            border: 1px solid #d1d5db; /* Tailwind border-gray-300 */
            margin-bottom: 1rem;
        }
        .info-window-content h3 {
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        .info-window-content p {
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem; /* leading-tight */
        }
        /* Custom styles for the slider labels to position them correctly */
        .slider-label-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.5rem; /* Adjust as needed */
            margin-bottom: 0.25rem;
        }

        /* Custom Alert/Message Box Styles */
        #customAlert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 1.5rem 2.5rem;
            border-radius: 0.75rem; /* rounded-xl */
            text-align: center;
            font-size: 1.25rem; /* text-xl */
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.3); /* shadow-lg */
            animation: fadeInOut 3s forwards; /* Animation for fade in and out */
            white-space: pre-wrap; /* Preserve whitespace and line breaks */
        }

        @keyframes fadeInOut {
            0% { opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4"
      data-shared-id="{{ shared_id|default('', true) }}">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl">
        <!-- 광고 이미지 추가 -->
        <!-- 광고 이미지 + 닫기 버튼 -->
        <div id="adBanner" class="relative mb-6">
        <a href="https://www.skku.edu/skku/" target="_blank" class="block w-full rounded-lg">
            <img src="/static/skku_ad_banner.png" alt="내 광고 배너"
                class="w-full h-auto object-cover rounded-lg">
        </a>
        <!-- 닫기(X) 버튼 -->
        <button type="button" aria-label="배너 닫기"
                class="absolute -top-2 -right-2 bg-black/70 text-white rounded-full w-8 h-8
                        flex items-center justify-center hover:bg-black/80 shadow-md"
                onclick="closeAdBanner()">
            ✕
        </button>
        </div>


        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">🤝 최적 미팅 장소 찾기</h1>
        <form id="locationForm" class="space-y-4">
            <div>
                <label for="map" class="block text-gray-700 text-sm font-semibold mb-2">
                    지도를 클릭하여 출발지 위치를 선택하세요 (마커를 클릭하여 제거)
                </label>
                <div id="map"></div>
                <input type="hidden" name="coords_json" id="coords_json">
            </div>
            <!-- 지도 바로 아래: 장소 검색 -->
            <div class="mt-2">
            <label for="placeSearch" class="sr-only">장소 검색</label>
            <!-- 여기 flex를 반응형으로: 모바일 세로, sm부터 가로 -->
            <div class="flex flex-col sm:flex-row gap-2 w-full">
                <input id="placeSearch" type="text" placeholder="장소 이름이나 주소를 검색하세요"
                class="min-w-0 flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-400"
                inputmode="search" enterkeyhint="search" />
                <button type="button" id="addFromSearchBtn"
                class="w-full sm:w-auto shrink-0 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg">
                검색으로 추가
                </button>
            </div>
            </div>



            <button type="button" id="useCurrentLocationBtn"
                    class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-offset-2 transition duration-300 ease-in-out transform hover:scale-105 mb-2">
                📍 현위치로 입력
            </button>
            <div id="currentLocationLoading" class="hidden text-center text-indigo-600 font-semibold mb-2">
                <!-- 스피너 SVG와 텍스트를 <span>으로 감싸서 JS가 찾을 수 있도록 함 -->
                <div class="flex items-center justify-center space-x-2">
                    <svg class="animate-spin h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>현위치 확인 중...</span> <!-- 이 부분이 핵심 수정: 텍스트를 <span>으로 감쌈 -->
                </div>
            </div>

            <button type="button" id="resetBtn"
                    class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2 transition duration-300 ease-in-out transform hover:scale-105 mb-4">
                지도 초기화
            </button>

            <!-- 람다(가중치) 슬라이더 -->
            <div class="mb-4">
                <label for="lambdaSlider" class="block text-gray-700 text-sm font-semibold mb-2">
                    <span class="block text-center mb-1">
                        최적화 기준 선택
                    </span>
                    <div class="slider-label-container">
                        <span class="font-bold text-blue-700 text-lg">평등</span>
                        <span class="font-bold text-green-700 text-lg">효율</span>
                    </div>
                    <input type="range" id="lambdaSlider" name="lambda" min="0" max="1" step="0.1" value="0.5"
                           class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-lg">
                    <span class="block text-center text-lg font-medium text-gray-800 mt-1">
                        가중치 (λ): <span id="lambdaValue">0.5</span> <!-- 초기값도 0.5로 수정 -->
                    </span>
                </label>
            </div>

            <button type="submit"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300 ease-in-out transform hover:scale-105">
                장소 찾기
            </button>
        </form>

        <div id="loadingIndicator" class="hidden text-center mt-4 text-blue-600 font-semibold">
            <div class="flex items-center justify-center space-x-2">
                <svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>장소를 찾고 있습니다...</span>
            </div>
        </div>

        <div id="resultsDisplay" class="mt-8 hidden">
            <!-- 결과가 여기에 동적으로 표시됩니다 --->
        </div>


                <!-- 경로 상세 컨트롤 -->
        <div class="mt-4 flex items-center gap-2">
        <label class="text-sm text-gray-600">경로 선호:</label>
        <select id="routePreference" class="border rounded px-2 py-1 text-sm">
            <option value="FEWER_TRANSFERS">환승 적게</option>
            <option value="LESS_WALKING">도보 적게</option>
        </select>
        <button id="btnShowRoutes"
                class="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50"
                disabled>
            모든 출발지 경로 보기
        </button>
        </div>

        <!-- 사람별 경로 결과 패널 -->
        <div id="routesPanel" class="mt-4 hidden">
        <!-- JS에서 카드들을 채워 넣습니다 -->
        </div>

                <div class="mt-4 flex justify-center">
        <button id="copyLinkBtn"
                class="hidden bg-gray-800 text-white font-bold py-2 px-4 rounded-lg hover:bg-black transition">
            링크 생성 & 복사
        </button>
        </div>

    </div>

    <!-- Custom Alert/Message Box -->
    <div id="customAlert" class="hidden"></div>

    <script>
        let map;
        let originMarkers = []; // 사용자가 클릭하여 추가한 출발지 마커 배열
        let resultMarkers = []; // 최적 역, 카페 등 결과 마커 배열
        let originCoords = []; // Flask로 전송될 위도/경도 객체 배열
        let infoWindow; // 마커 클릭 시 정보 창
        let directionsService; // 경로 검색 서비스
        let directionsRenderers = []; // 경로 표시 렌더러 배열 (각 출발지마다)
        let placesService; // 검색용 PlacesService
        let routePolylines = []; // 버스/직접 모드에서 그린 선들을 담아두는 배열
        let selectedDestination = null;
        let lastResult = null; // 서버에 저장할 최신 결과
        let mapReady = false;
        let deferredSharedData = null;
        function renderShared(data) {
        if (!mapReady) { deferredSharedData = data; return; }

        // 🔧 저장된 출발지로 빨간 마커 복원
        if ((!originMarkers || originMarkers.length === 0) && Array.isArray(data.origins)) {
            data.origins.forEach(o => {
            if (o && typeof o.lat === 'number' && typeof o.lng === 'number') {
                addOriginMarker({ lat: o.lat, lng: o.lng });
            }
            });
        }

        lastResult = data;
        displayResultsOnMap(data);  // 여기서 경로/폴리라인이 originMarkers를 사용
        displayResultsText(data);
        document.getElementById("copyLinkBtn")?.classList.remove("hidden");
        }

         async function copyTextToClipboard(text) {
            try {
            await navigator.clipboard.writeText(text);
            showCustomAlert("링크가 복사되었습니다! ✅");
            } catch (e) {
            // clipboard API가 막힌 환경 대비
            const ta = document.createElement('textarea');
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
            showCustomAlert("링크가 복사되었습니다! ✅");
            }
        }

        // Function to show custom alert message
        function showCustomAlert(message) {
            const customAlert = document.getElementById("customAlert");
            customAlert.textContent = message;
            customAlert.classList.remove("hidden");
            // Set a timeout to hide the message after 3 seconds
            setTimeout(() => {
                customAlert.classList.add("hidden");
            }, 3000); 
        }

        function updateCoordsJson() {
            document.getElementById("coords_json").value = JSON.stringify(originCoords);
        }
        
        function initMap() {
            const seoul = { lat: 37.5665, lng: 126.9780 };
            map = new google.maps.Map(document.getElementById("map"), {
                center: seoul,
                zoom: 12,
                gestureHandling: "greedy"
            });
            mapReady = true;
            if (deferredSharedData) {
                const tmp = deferredSharedData;
                deferredSharedData = null;
                renderShared(tmp);
            }
            infoWindow = new google.maps.InfoWindow();
            directionsService = new google.maps.DirectionsService();

            // 지도 클릭 이벤트 리스너: 클릭 시 마커 추가 (LatLng 객체를 일반 객체로 변환하여 전달)
            map.addListener("click", (e) => {
                addOriginMarker({ lat: e.latLng.lat(), lng: e.latLng.lng() });
            });

            document.getElementById("resetBtn").addEventListener("click", resetMap);
            document.getElementById("locationForm").addEventListener("submit", handleFormSubmit);
            document.getElementById("useCurrentLocationBtn").addEventListener("click", useCurrentLocation);

            const lambdaSlider = document.getElementById("lambdaSlider");
            const lambdaValueSpan = document.getElementById("lambdaValue");
            lambdaSlider.addEventListener("input", () => {
                lambdaValueSpan.textContent = parseFloat(lambdaSlider.value).toFixed(1);
            });
            // --- 검색 위젯: 지도 바로 아래 입력창 ---
            const searchInput = document.getElementById("placeSearch");
            placesService = new google.maps.places.PlacesService(map);

            // 자동완성: 드롭다운 선택 시 바로 추가
            const autocomplete = new google.maps.places.Autocomplete(searchInput, {
            fields: ["place_id", "geometry", "name", "formatted_address"],
            componentRestrictions: { country: "kr" }
            });
            autocomplete.bindTo("bounds", map);

            autocomplete.addListener("place_changed", () => {
            const place = autocomplete.getPlace();
            if (!place || !place.geometry || !place.geometry.location) {
                if (searchInput.value.trim()) textSearchAdd(searchInput.value.trim());
                return;
            }
            const loc = place.geometry.location;
            const pos = { lat: loc.lat(), lng: loc.lng() };
            addOriginMarker(pos);
            map.panTo(pos);
            map.setZoom(14);
            searchInput.value = "";
            });

            // 엔터키로도 추가(자동완성 미선택 대비)
            searchInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                if (searchInput.value.trim()) textSearchAdd(searchInput.value.trim());
            }
            });

            // 버튼 클릭으로 추가
            document.getElementById("addFromSearchBtn").addEventListener("click", () => {
            if (searchInput.value.trim()) textSearchAdd(searchInput.value.trim());
            });

            // 텍스트 검색(첫 결과를 좌표로 변환)
            function textSearchAdd(query) {
            placesService.textSearch(
                { query, location: map.getCenter(), radius: 50000 }, // 필요시 반경 조정
                (results, status) => {
                if (status !== google.maps.places.PlacesServiceStatus.OK || !results?.length) {
                    alert("검색 결과를 찾지 못했습니다.");
                    return;
                }
                const first = results[0];
                if (!first.geometry?.location) {
                    alert("이 장소는 좌표가 없습니다.");
                    return;
                }
                const loc = first.geometry.location;
                const pos = { lat: loc.lat(), lng: loc.lng() };
                addOriginMarker(pos);
                map.panTo(pos);
                map.setZoom(14);
                searchInput.value = "";
                }
            );
            }

        }
        function resetMap() {
        // 1) 결과/출발지 모두 삭제
        clearResultMarkers();
        clearOriginMarkers();

        // 2) 지도 초기 상태로
        const seoul = { lat: 37.5665, lng: 126.9780 };
        map.setCenter(seoul);
        map.setZoom(12);

        // 3) 결과 패널/로딩/히든 값 초기화
        const results = document.getElementById("resultsDisplay");
        document.getElementById("coords_json").value = "[]";

        // 4) 커스텀 알럿 닫기
        document.getElementById("customAlert")?.classList.add("hidden");
        }

        function useCurrentLocation() {
            const loadingIndicatorDiv = document.getElementById("currentLocationLoading");
            const loadingTextSpan = loadingIndicatorDiv.querySelector("span");
            const spinnerSvg = loadingIndicatorDiv.querySelector("svg");

            // 초기 상태: '현위치 확인 중...' 문구 표시
            loadingTextSpan.textContent = "현위치 확인 중...";
            spinnerSvg.classList.remove("hidden"); // 스피너 표시
            loadingIndicatorDiv.classList.remove("hidden"); // 로딩 인디케이터 표시

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };
                        addOriginMarker(pos); // 핀 추가 함수 호출
                        map.panTo(pos);
                        map.setZoom(14);

                        // ✨ 수정된 부분: 핀 추가 및 지도 업데이트 직후 '입력 완료' 메시지로 변경
                        spinnerSvg.classList.add("hidden"); // 스피너 숨김
                        loadingTextSpan.textContent = "현위치 입력 완료! ✅";
                        
                        // 그 다음 5초 뒤 로딩 인디케이터를 숨김
                        setTimeout(() => {
                            loadingIndicatorDiv.classList.add("hidden");
                        }, 5000); // "입력 완료" 메시지가 2초간 보인 후 사라짐
                    },
                    (error) => {
                        // 오류 발생 시 즉시 숨김
                        loadingIndicatorDiv.classList.add("hidden");
                        let errorMessage = "현위치를 가져올 수 없습니다.";
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = "위치 정보 사용 권한이 거부되었습니다. 브라우저 설정에서 위치 정보 접근을 허용해주세요.";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = "위치 정보를 사용할 수 없습니다. 잠시 후 다시 시도해주세요.";
                                break;
                            case error.TIMEOUT:
                                errorMessage = "위치 정보를 가져오는 시간이 초과되었습니다. 안정적인 네트워크에서 다시 시도해주세요.";
                                break;
                        }
                        alert(errorMessage);
                        console.error("Geolocation Error:", error);
                    }
                );
            } else {
                // 브라우저가 지원하지 않을 경우 즉시 숨김
                loadingIndicatorDiv.classList.add("hidden");
                alert("이 브라우저는 현위치 기능을 지원하지 않습니다.");
            }
        }

        function addOriginMarker(location) {
             if (location.lat <= -60) {
                showCustomAlert("혹시 펭귄이신가요? 🐧");
            }
            // 이제 location은 항상 {lat: value, lng: value} 형태의 일반 객체이므로 .lat, .lng로 직접 접근
            const isDuplicate = originCoords.some(coord =>
                Math.abs(coord.lat - location.lat) < 1e-6 && Math.abs(coord.lng - location.lng) < 1e-6
            );

            if (isDuplicate) {
                console.log("동일한 위치에 핀을 추가하려는 시도를 무시합니다.");
                return; // 중복이면 추가하지 않고 함수 종료
            }

            const marker = new google.maps.Marker({
                position: location, // location은 이미 {lat, lng} 형태이므로 그대로 사용 가능
                map: map,
                icon: {
                    url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png"
                },
                clickable: true // 마커 클릭 가능하도록 설정
            });

            originMarkers.push(marker);
            originCoords.push({ lat: location.lat, lng: location.lng }); // ✨ 수정된 부분: location.lat(), location.lng() -> location.lat, location.lng
            updateCoordsJson(); // hidden input 업데이트

            // **새로운 기능: 마커 클릭 시 개별 삭제**
            marker.addListener("click", () => {
                // 이 마커가 originMarkers 배열의 몇 번째인지 찾습니다.
                const index = originMarkers.indexOf(marker);
                if (index > -1) {
                    // 지도에서 마커 제거
                    marker.setMap(null);

                    // 배열에서 마커와 해당 좌표 제거
                    originMarkers.splice(index, 1);
                    originCoords.splice(index, 1);

                    updateCoordsJson(); // hidden input 업데이트
                    console.log("마커가 제거되었습니다. 현재 선택된 출발지 좌표:", originCoords);

                    // 만약 이 마커의 정보창이 열려있다면 닫습니다.
                    if (infoWindow && infoWindow.getMap() === map) {
                        infoWindow.close();
                    }
                }
            });

            console.log("현재 선택된 출발지 좌표:", originCoords);
        }

        function clearOriginMarkers() {
            for (let i = 0; i < originMarkers.length; i++) {
                originMarkers[i].setMap(null); // 지도에서 모든 마커 제거
            }
            originMarkers = []; // 마커 배열 비우기
            originCoords = []; // 좌표 배열 비우기
            updateCoordsJson(); // hidden input 업데이트
            console.log("모든 출발지 핀이 제거되었습니다.");
        }

        function clearResultMarkers() {
        // 결과 마커 제거
        for (let i = 0; i < resultMarkers.length; i++) {
            resultMarkers[i].setMap(null);
        }
        resultMarkers = [];

        // 경로 렌더러 제거(대중교통 경로)
        for (let i = 0; i < directionsRenderers.length; i++) {
            directionsRenderers[i].setMap(null);
        }
        directionsRenderers = [];

        // 직접 그린 폴리라인(버스/직접 모드) 제거
        for (let i = 0; i < routePolylines.length; i++) {
            routePolylines[i].setMap(null);
        }
        routePolylines = [];

        if (infoWindow) {
            infoWindow.close();
        }
        }


        async function handleFormSubmit(event) {
            event.preventDefault();

            if (originCoords.length === 0) {
                alert("최소 하나 이상의 출발지 위치를 선택해주세요.");
                return;
            }

            clearResultMarkers();
            document.getElementById("resultsDisplay").classList.add("hidden");
            document.getElementById("loadingIndicator").classList.remove("hidden");

            const formData = new FormData();
            formData.append('coords_json', JSON.stringify(originCoords));
            formData.append('lambda', document.getElementById("lambdaSlider").value);

            try {
                const response = await fetch('/api/find_places', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    lastResult = result;
                    displayResultsOnMap(result);
                    displayResultsText(result);
                    document.getElementById("copyLinkBtn")?.classList.remove("hidden");
                } else {
                    alert(`오류: ${result.error || result.message || '알 수 없는 오류가 발생했습니다.'}`);
                    console.error("API Error:", result);
                    document.getElementById("resultsDisplay").innerHTML = `<p class="text-red-600 text-lg font-medium text-center p-4 bg-red-50 rounded-lg border border-red-200">
                                                                            오류: ${result.error || result.message || '알 수 없는 오류가 발생했습니다.'}
                                                                          </p>`;
                    document.getElementById("resultsDisplay").classList.remove("hidden");
                }
            } catch (error) {
                console.error("Fetch Error:", error);
                alert("네트워크 오류 또는 서버 응답 문제 발생!");
                document.getElementById("resultsDisplay").innerHTML = `<p class="text-red-600 text-lg font-medium text-center p-4 bg-red-50 rounded-lg border border-red-200">
                                                                        네트워크 오류 또는 서버 응답 문제 발생: ${error.message}
                                                                      </p>`;
                document.getElementById("resultsDisplay").classList.remove("hidden");
            } finally {
                document.getElementById("loadingIndicator").classList.add("hidden");
            }
        }

        function displayResultsOnMap(data) {
            const bounds = new google.maps.LatLngBounds();
            originMarkers.forEach(marker => bounds.extend(marker.getPosition())); // Always include origin markers

            // Handle results based on result_type
            let mainPlacePos = null;
            let mainPlaceTitle = "";
            let mainPlaceIcon = "";
            let mainPlaceContent = "";

            if (data.result_type === "transit_station" && data.best_station) {
                mainPlacePos = { lat: data.best_station.lat, lng: data.best_station.lng };
                selectedDestination = mainPlacePos;
                document.getElementById("btnShowRoutes").disabled = false;
                mainPlaceTitle = data.best_station.name;
                mainPlaceIcon = "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"; // Blue for transit station
                mainPlaceContent = `
                    <div class="info-window-content">
                        <h3>📍 최적 미팅역: ${data.best_station.name}</h3>
                        <p>평균 이동 시간: ${data.best_station.avg_min.toFixed(1)}분</p>
                        <p>최대 이동 시간: ${data.best_station.max_min.toFixed(1)}분</p>
                `;
                if (data.best_station.times && data.best_station.times.length > 0) {
                    mainPlaceContent += `<p>개별 이동 시간 (일부):</p><ul>`;
                    const timesToShow = data.best_station.times.slice(0, Math.min(data.best_station.times.length, 3));
                    timesToShow.forEach((time, index) => {
                        mainPlaceContent += `<li>출발지 ${index + 1}: ${time.toFixed(1)}분</li>`;
                    });
                    mainPlaceContent += `</ul>`;
                }
                mainPlaceContent += `</div>`;

                // Draw transit routes
                originMarkers.forEach((originMarker, index) => {
                    const request = {
                        origin: originMarker.getPosition(),
                        destination: mainPlacePos,
                        travelMode: google.maps.TravelMode.TRANSIT,
                    };
                    directionsService.route(request, (result, status) => {
                        if (status === google.maps.DirectionsStatus.OK) {
                            const directionsRenderer = new google.maps.DirectionsRenderer({
                                map: map,
                                suppressMarkers: true,
                                polylineOptions: { strokeColor: 'blue', strokeOpacity: 0.6, strokeWeight: 4 }
                            });
                            directionsRenderer.setDirections(result);
                            directionsRenderers.push(directionsRenderer);
                        } else {
                            console.error(`출발지 ${index + 1}에서 역까지의 대중교통 경로를 찾을 수 없습니다: ${status}`);
                        }
                    });
                });

            } else if (data.result_type === "bus_terminal" && data.best_bus_terminal) {
                mainPlacePos = { lat: data.best_bus_terminal.lat, lng: data.best_bus_terminal.lng };
                selectedDestination = mainPlacePos;
                document.getElementById("btnShowRoutes").disabled = false;
                mainPlaceTitle = data.best_bus_terminal.name;
                mainPlaceIcon = "http://maps.google.com/mapfiles/ms/icons/orange-dot.png"; // Orange for bus terminal
                mainPlaceContent = `
                    <div class="info-window-content">
                        <h3>🚌 최적 버스 터미널: ${data.best_bus_terminal.name}</h3>
                        <p>중심 지점으로부터 거리: ${data.best_bus_terminal.distance_km.toFixed(2)} km</p>
                    </div>
                `;
                // Draw simple lines for bus terminal (Directions API transit mode may be limited for bus)
                originMarkers.forEach((originMarker, index) => {
                     const line = new google.maps.Polyline({
                        path: [originMarker.getPosition(), mainPlacePos],
                        geodesic: true,
                        strokeColor: '#FF9800', // 혹은 '#800080' (직접 모드)
                        strokeOpacity: 0.6,
                        strokeWeight: 2,
                        map: map
                        });
                        routePolylines.push(line);

                });

            } else if (data.result_type === "direct_places" && (data.direct_nearby_places_cafes.length > 0 || data.direct_nearby_places_study_cafes.length > 0)) {
                mainPlacePos = { lat: data.best_point.lat, lng: data.best_point.lng };
                mainPlaceTitle = "최적 중심 지점";
                mainPlaceIcon = "http://maps.google.com/mapfiles/ms/icons/purple-dot.png"; // Purple for direct places center
                mainPlaceContent = `
                    <div class="info-window-content">
                        <h3>✨ 최적 중심 지점</h3>
                        <p>역/터미널 대신 이 주변에서 만남을 고려해보세요.</p>
                    </div>
                `;
                 // Draw simple lines to best point
                originMarkers.forEach((originMarker, index) => {
                     new google.maps.Polyline({
                        path: [originMarker.getPosition(), mainPlacePos],
                        geodesic: true,
                        strokeColor: '#800080',
                        strokeOpacity: 0.6,
                        strokeWeight: 2,
                        map: map
                    });
                });
            }

            // Add main place marker if found
            if (mainPlacePos) {
                const mainPlaceMarker = new google.maps.Marker({
                    position: mainPlacePos,
                    map: map,
                    icon: { url: mainPlaceIcon },
                    title: mainPlaceTitle
                });
                resultMarkers.push(mainPlaceMarker);
                bounds.extend(mainPlacePos);
                mainPlaceMarker.addListener("click", () => {
                    infoWindow.setContent(mainPlaceContent);
                    infoWindow.open(map, mainPlaceMarker);
                });
            }
            
            // Add nearby cafes (green dot)
            const cafesToDisplay = data.cafes_list || data.direct_nearby_places_cafes || [];
            cafesToDisplay.forEach(cafe => {
                const cafePos = { lat: cafe.lat, lng: cafe.lng };
                const cafeMarker = new google.maps.Marker({
                    position: cafePos,
                    map: map,
                    icon: { url: "http://maps.google.com/mapfiles/ms/icons/green-dot.png" },
                    title: cafe.name
                });
                resultMarkers.push(cafeMarker);
                bounds.extend(cafePos);

                const cafeContent = `
                    <div class="info-window-content">
                        <h3>☕ 카페: ${cafe.name}</h3>
                        <p>거리: ${cafe.distance_km.toFixed(2)} km</p>
                        <p>위치: ${cafe.lat.toFixed(6)}, ${cafe.lng.toFixed(6)}</p>
                    </div>
                `;
                cafeMarker.addListener("click", () => {
                    infoWindow.setContent(cafeContent);
                    infoWindow.open(map, cafeMarker);
                    selectedDestination = cafePos;
                    document.getElementById("btnShowRoutes").disabled = false;
                });
            });

            // Add nearby study cafes (yellow dot)
            const studyCafesToDisplay = data.study_cafes_list || data.direct_nearby_places_study_cafes || [];
            studyCafesToDisplay.forEach(studyCafe => {
                const studyCafePos = { lat: studyCafe.lat, lng: studyCafe.lng };
                const studyCafeMarker = new google.maps.Marker({
                    position: studyCafePos,
                    map: map,
                    icon: { url: "http://maps.google.com/mapfiles/ms/icons/yellow-dot.png" },
                    title: studyCafe.name
                });
                resultMarkers.push(studyCafeMarker);
                bounds.extend(studyCafePos);

                const studyCafeContent = `
                    <div class="info-window-content">
                        <h3>📚 스터디카페: ${studyCafe.name}</h3>
                        <p>거리: ${studyCafe.distance_km.toFixed(2)} km</p>
                        <p>위치: ${studyCafe.lat.toFixed(6)}, ${studyCafe.lng.toFixed(6)}</p>
                        <button class="mt-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"
                                onclick="showCustomAlert('⏳ 아직은 비밀\\n조금만 기다리면 예약까지 한 번에!')">예약하기</button>
                    </div>
                `;
                studyCafeMarker.addListener("click", () => {
                    infoWindow.setContent(studyCafeContent);
                    infoWindow.open(map, studyCafeMarker);
                    selectedDestination = studyCafePos;
                    document.getElementById("btnShowRoutes").disabled = false;
                });
            });

            if (data.result_type === "no_places_found" || data.error) {
                console.warn("No places found or an error occurred. Map will only show origin markers.");
            }
            map.fitBounds(bounds);
        }

        function displayResultsText(data) {
            const resultsDisplay = document.getElementById("resultsDisplay");
            let htmlContent = '';

            if (data.error) {
                htmlContent += `
                    <p class="text-red-600 text-lg font-medium text-center p-4 bg-red-50 rounded-lg border border-red-200">
                        오류: ${data.error}
                    </p>
                `;
            } else if (data.result_type === "transit_station" && data.best_station) {
                htmlContent += `
                    <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <h2 class="text-2xl font-semibold text-blue-800 mb-3">📍 최적 미팅역 (지하철/기차)</h2>
                        <p class="text-lg text-gray-700 mb-2"><strong>이름:</strong> ${data.best_station.name}</p>
                        <p class="text-lg text-gray-700 mb-2"><strong>위치:</strong> ${data.best_station.lat.toFixed(6)}, ${data.best_station.lng.toFixed(6)}</p>
                        <p class="text-lg text-gray-700 mb-2"><strong>평균 이동 시간:</strong> ${data.best_station.avg_min.toFixed(1)}분</p>
                        <p class="text-lg text-gray-700 mb-2"><strong>최대 이동 시간:</strong> ${data.best_station.max_min.toFixed(1)}분</p>
                `;
                if (data.best_station.times && data.best_station.times.length > 0) {
                    htmlContent += `<h3 class="text-xl font-semibold text-blue-700 mt-4 mb-2">각 출발지에서 역까지 이동 시간:</h3>`;
                    htmlContent += `<ul class="list-disc pl-5 space-y-1 text-gray-700">`;
                    data.best_station.times.forEach((time, index) => {
                        htmlContent += `<li>출발지 ${index + 1}: ${time.toFixed(1)}분</li>`;
                    });
                    htmlContent += `</ul>`;
                }
                htmlContent += `</div>`;

                // Display Cafes
                if (data.cafes_list && data.cafes_list.length > 0) {
                    htmlContent += `
                        <div class="mb-6 p-4 bg-green-50 rounded-lg border border-green-200">
                            <h2 class="text-2xl font-semibold text-green-800 mb-3">☕ 주변 카페 (상위 5개)</h2>
                            <ul class="list-disc pl-5 space-y-2 text-gray-700">
                    `;
                    data.cafes_list.forEach(cafe => {
                        htmlContent += `
                                <li>
                                    <strong>${cafe.name}</strong> (거리: ${cafe.distance_km.toFixed(2)} km)
                                    <span class="text-sm text-gray-500">(${cafe.lat.toFixed(6)}, ${cafe.lng.toFixed(6)})</span>
                                </li>
                        `;
                    });
                    htmlContent += `
                            </ul>
                        </div>
                    `;
                }

                // Display Study Cafes
                if (data.study_cafes_list && data.study_cafes_list.length > 0) {
                    htmlContent += `
                        <div class="mb-6 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                            <h2 class="text-2xl font-semibold text-yellow-800 mb-3">📚 주변 스터디카페 (상위 5개)</h2>
                            <ul class="list-disc pl-5 space-y-2 text-gray-700">
                    `;
                    data.study_cafes_list.forEach(studyCafe => {
                        htmlContent += `
                                <li>
                                    <strong>${studyCafe.name}</strong> (거리: ${studyCafe.distance_km.toFixed(2)} km)
                                    <span class="text-sm text-gray-500">(${studyCafe.lat.toFixed(6)}, ${studyCafe.lng.toFixed(6)})</span>
                                    <button class="ml-2 px-3 py-1 bg-blue-500 text-white text-sm rounded-md hover:bg-blue-600 transition-colors"
                                            onclick="showCustomAlert('⏳ 아직은 비밀\\n조금만 기다리면 예약까지 한 번에!')">예약하기</button>
                                </li>
                        `;
                    });
                    htmlContent += `
                            </ul>
                        </div>
                    `;
                }

                if (!(data.cafes_list && data.cafes_list.length > 0) && !(data.study_cafes_list && data.study_cafes_list.length > 0)) {
                    htmlContent += `
                        <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <h2 class="text-2xl font-semibold text-gray-800 mb-3">☕ 주변 장소</h2>
                            <p class="text-gray-700">주변에 찾을 수 있는 카페나 스터디카페가 없습니다.</p>
                        </div>
                    `;
                }

            } else if (data.result_type === "bus_terminal" && data.best_bus_terminal) {
                htmlContent += `
                    <div class="mb-6 p-4 bg-orange-50 rounded-lg border border-orange-200">
                        <h2 class="text-2xl font-semibold text-orange-800 mb-3">🚌 최적 미팅 버스 터미널</h2>
                        <p class="text-lg text-gray-700 mb-2"><strong>이름:</strong> ${data.best_bus_terminal.name}</p>
                        <p class="text-lg text-gray-700 mb-2"><strong>위치:</strong> ${data.best_bus_terminal.lat.toFixed(6)}, ${data.best_bus_terminal.lng.toFixed(6)}</p>
                        <p class="text-lg text-gray-700 mb-2"><strong>중심 지점으로부터 거리:</strong> ${data.best_bus_terminal.distance_km.toFixed(2)} km</p>
                    </div>
                `;
                // Display Cafes for bus terminal
                if (data.cafes_list && data.cafes_list.length > 0) {
                    htmlContent += `
                        <div class="mb-6 p-4 bg-green-50 rounded-lg border border-green-200">
                            <h2 class="text-2xl font-semibold text-green-800 mb-3">☕ 주변 카페 (상위 5개)</h2>
                            <ul class="list-disc pl-5 space-y-2 text-gray-700">
                    `;
                    data.cafes_list.forEach(cafe => {
                        htmlContent += `
                                <li>
                                    <strong>${cafe.name}</strong> (거리: ${cafe.distance_km.toFixed(2)} km)
                                    <span class="text-sm text-gray-500">(${cafe.lat.toFixed(6)}, ${cafe.lng.toFixed(6)})</span>
                                </li>
                        `;
                    });
                    htmlContent += `
                            </ul>
                        </div>
                    `;
                }
                // Display Study Cafes for bus terminal
                if (data.study_cafes_list && data.study_cafes_list.length > 0) {
                    htmlContent += `
                        <div class="mb-6 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                            <h2 class="text-2xl font-semibold text-yellow-800 mb-3">📚 주변 스터디카페 (상위 5개)</h2>
                            <ul class="list-disc pl-5 space-y-2 text-gray-700">
                    `;
                    data.study_cafes_list.forEach(studyCafe => {
                        htmlContent += `
                                <li>
                                    <strong>${studyCafe.name}</strong> (거리: ${studyCafe.distance_km.toFixed(2)} km)
                                    <span class="text-sm text-gray-500">(${studyCafe.lat.toFixed(6)}, ${studyCafe.lng.toFixed(6)})</span>
                                    <button class="ml-2 px-3 py-1 bg-blue-500 text-white text-sm rounded-md hover:bg-blue-600 transition-colors"
                                            onclick="showCustomAlert('⏳ 아직은 비밀\\n조금만 기다리면 예약까지 한 번에!')">예약하기</button>
                                </li>
                        `;
                    });
                    htmlContent += `
                            </ul>
                        </div>
                    `;
                }

                if (!(data.cafes_list && data.cafes_list.length > 0) && !(data.study_cafes_list && data.study_cafes_list.length > 0)) {
                    htmlContent += `
                        <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <h2 class="text-2xl font-semibold text-gray-800 mb-3">☕ 주변 장소</h2>
                            <p class="text-gray-700">주변에 찾을 수 있는 카페나 스터디카페가 없습니다.</p>
                        </div>
                    `;
                }

            } else if (data.result_type === "direct_places" && (data.direct_nearby_places_cafes.length > 0 || data.direct_nearby_places_study_cafes.length > 0)) {
                htmlContent += `
                    <div class="mb-6 p-4 bg-purple-50 rounded-lg border border-purple-200">
                        <h2 class="text-2xl font-semibold text-purple-800 mb-3">✨ 중심 지점 주변 장소 (역/터미널 없음)</h2>
                        <p class="text-lg text-gray-700 mb-2">최적의 역(지하철/버스)을 찾을 수 없어, 중심 지점 주변의 카페/스터디카페를 찾았습니다.</p>
                `;
                // Display Direct Cafes
                if (data.direct_nearby_places_cafes && data.direct_nearby_places_cafes.length > 0) {
                    htmlContent += `
                        <h3 class="text-xl font-semibold text-green-700 mt-4 mb-2">☕ 주변 카페 (상위 5개)</h3>
                        <ul class="list-disc pl-5 space-y-2 text-gray-700">
                    `;
                    data.direct_nearby_places_cafes.forEach(cafe => {
                        htmlContent += `
                                <li>
                                    <strong>${cafe.name}</strong> (거리: ${cafe.distance_km.toFixed(2)} km)
                                    <span class="text-sm text-gray-500">(${cafe.lat.toFixed(6)}, ${cafe.lng.toFixed(6)})</span>
                                </li>
                        `;
                    });
                    htmlContent += `
                        </ul>
                    `;
                }
                // Display Direct Study Cafes
                if (data.direct_nearby_places_study_cafes && data.direct_nearby_places_study_cafes.length > 0) {
                    htmlContent += `
                        <h3 class="text-xl font-semibold text-yellow-700 mt-4 mb-2">📚 주변 스터디카페 (상위 5개)</h3>
                        <ul class="list-disc pl-5 space-y-2 text-gray-700">
                    `;
                    data.direct_nearby_places_study_cafes.forEach(studyCafe => {
                        htmlContent += `
                                <li>
                                    <strong>${studyCafe.name}</strong> (거리: ${studyCafe.distance_km.toFixed(2)} km)
                                    <span class="text-sm text-gray-500">(${studyCafe.lat.toFixed(6)}, ${studyCafe.lng.toFixed(6)})</span>
                                    <button class="ml-2 px-3 py-1 bg-blue-500 text-white text-sm rounded-md hover:bg-blue-600 transition-colors"
                                            onclick="showCustomAlert('⏳ 아직은 비밀\\n조금만 기다리면 예약까지 한 번에!')">예약하기</button>
                                </li>
                        `;
                    });
                    htmlContent += `
                        </ul>
                    `;
                }
                htmlContent += `</div>`; // Close the main div for direct_places

            } else if (data.result_type === "no_places_found") {
                htmlContent += `
                    <p class="text-red-600 text-lg font-medium text-center p-4 bg-red-50 rounded-lg border border-red-200">
                        죄송합니다. 적절한 미팅 장소나 주변 편의 시설을 찾을 수 없습니다.
                    </p>
                `;
            } else {
                 htmlContent += `
                    <p class="text-red-600 text-lg font-medium text-center p-4 bg-red-50 rounded-lg border border-red-200">
                        죄송합니다. 유효한 결과를 찾을 수 없습니다. 다시 시도해 주세요.
                    </p>
                `;
            }
            resultsDisplay.innerHTML = htmlContent;
            resultsDisplay.classList.remove("hidden");
        }
        function closeAdBanner() {
            const el = document.getElementById('adBanner');
            if (el) {
            el.style.display = 'none';
            }
        }

        // 페이지 로드 시 배너 숨김 여부 반영
        document.addEventListener('DOMContentLoaded', () => {
            try {
            if (localStorage.getItem('hide_ad_banner') === '1') {
                const el = document.getElementById('adBanner');
                if (el) el.style.display = 'none';
            }
            } catch (e) {
            // private browsing 등 localStorage 불가 환경 대비: 조용히 무시
            }
        });

        document.addEventListener('DOMContentLoaded', async () => {
        const sharedId = document.body.getAttribute('data-shared-id'); // 또는 .dataset.sharedId
        if (sharedId) {
            try {
            const r = await fetch(`/api/shared/${sharedId}`);
            const data = await r.json();
            if (r.ok && data) {
                renderShared(data); // mapReady가 false면 내부에서 지연 렌더
            } else {
                alert(data.error || '공유 데이터를 불러오지 못했습니다.');
            }
            } catch (e) {
            console.error(e);
            alert('공유 데이터 로드 실패');
            }
        }
        });
    </script>
    <!-- YOUR_GOOGLE_MAPS_API_KEY를 실제 Google Maps API 키로 교체하세요 -->
    <!-- 반드시 Maps JavaScript API, Places API, Distance Matrix API, Directions API가 활성화되어 있어야 합니다. -->
     <script>
    const copyLinkBtn = document.getElementById("copyLinkBtn");
    copyLinkBtn.addEventListener("click", async () => {
    if (!lastResult) {
        alert("공유할 결과가 없습니다. 먼저 검색하세요.");
        return;
    }
    try {
        const payload = { ...lastResult, origins: originCoords };
        // 1) 서버에 결과 저장 → id 수신
        const res = await fetch("/api/save_result", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload),
        });
        const json = await res.json();
        if (!res.ok) throw new Error(json.error || "저장 실패");

        const id = json.id;
        const base = location.origin;
        const link = `${base}/share/${id}`;
        // 3) 클립보드 복사
        await copyTextToClipboard(link);
    } catch (e) {
        console.error(e);
        alert(`링크 생성 실패: ${e.message}`);
    }
    });

  const ROUTE_COLORS = ["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd",
                        "#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"];

  function fmtTime(ts) {
    try { return new Date(ts).toTimeString().slice(0,5); } catch(e) { return ""; }
  }

  // 주소 보기 좋게 정리
function cleanAddress(str = "") {
  return String(str)
    .replace(/^대한민국\s*/, "")
    .replace(/\(\d{5}\)\s*/g, "")
    .trim();
}
function vehicleEmoji(type) {
  switch (type) {
    case "SUBWAY": return "🚇";
    case "HEAVY_RAIL":
    case "COMMUTER_TRAIN":
    case "RAIL": return "🚉";
    case "BUS": return "🚌";
    case "TRAM": return "🚊";
    default: return "🚆";
  }
}

function stepToHTML(step) {
  if (step.travel_mode === "WALKING") {
    const d = step.distance?.text ?? "";
    const t = step.duration?.text ?? "";
    return `<li class="leading-6">🚶 도보 <span class="text-gray-700">${d}</span> · <span class="text-gray-700">약 ${t}</span></li>`;
  }
  if (step.travel_mode === "TRANSIT") {
    // ✅ JS SDK는 step.transit 사용 (transit_details 아님)
    const td = step.transit || step.transit_details;
    if (!td) return `<li>대중교통 구간</li>`;
    const lineName = td.line?.short_name || td.line?.name || "노선";
    const vType = td.line?.vehicle?.type || "";
    const from = cleanAddress(td.departure_stop?.name || "");
    const to   = cleanAddress(td.arrival_stop?.name || "");
    const depT = td.departure_time?.text || (td.departure_time?.value ? new Date(td.departure_time.value).toTimeString().slice(0,5) : "");
    const arrT = td.arrival_time?.text || (td.arrival_time?.value ? new Date(td.arrival_time.value).toTimeString().slice(0,5) : "");
    const stops = (td.num_stops != null) ? `${td.num_stops} 정거장` : "";
    const head  = td.headsign ? ` (${td.headsign})` : "";
    const bg = td.line?.color || "#eef2ff";     // 노선 색상
    const fg = td.line?.text_color || "#111827";

    return `
      <li class="leading-6">
        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold"
              style="background:${bg};color:${fg};border:1px solid rgba(0,0,0,0.06);">
          ${vehicleEmoji(vType)} ${lineName}
        </span>
        <span class="ml-2">${from} → ${to}${head}</span>
        <span class="ml-2 text-gray-600">${stops}</span>
        <span class="ml-2 text-gray-500">${depT}~${arrT}</span>
      </li>`;
  }
  return `<li>기타 구간</li>`;
}


  async function showRoutesForAll() {
    if (!selectedDestination) { alert("먼저 목적지를 선택(미팅역/터미널/카페 클릭)하세요."); return; }
    if (!originCoords?.length) { alert("출발지를 먼저 추가하세요."); return; }

    // 기존 경로 렌더러 지우기
    for (let i = 0; i < directionsRenderers.length; i++) directionsRenderers[i].setMap(null);
    directionsRenderers = [];

    const prefRaw = document.getElementById("routePreference").value;
    const routingPreference =
      (prefRaw === "LESS_WALKING")
        ? google.maps.TransitRoutePreference.LESS_WALKING
        : google.maps.TransitRoutePreference.FEWER_TRANSFERS;

    const panel = document.getElementById("routesPanel");
    panel.classList.remove("hidden");
    panel.innerHTML = "";

    // 출발지별로 경로 요청
    const tasks = originCoords.map((orig, idx) => new Promise((resolve) => {
      directionsService.route({
        origin: new google.maps.LatLng(orig.lat, orig.lng),
        destination: new google.maps.LatLng(selectedDestination.lat, selectedDestination.lng),
        travelMode: google.maps.TravelMode.TRANSIT,
        transitOptions: { routingPreference, departureTime: new Date() },
        provideRouteAlternatives: false,
        region: "KR"
      }, (result, status) => {
        const card = document.createElement("div");
        card.className = "mb-4 p-4 rounded-lg border bg-white shadow-sm";

        if (status !== google.maps.DirectionsStatus.OK || !result?.routes?.length) {
          card.innerHTML = `<div class="font-semibold">출발지 ${idx+1} (${orig.lat.toFixed(4)}, ${orig.lng.toFixed(4)})</div>
                            <div class="text-red-600">경로를 찾지 못했습니다.</div>`;
          panel.appendChild(card);
          return resolve();
        }

        const route = result.routes[0];
        const leg = route.legs?.[0];
        const startLabel = cleanAddress(leg?.start_address || `출발지 ${idx+1}`);

        const steps = leg?.steps ?? [];
        const durationText = leg?.duration?.text ?? "-";
        const arrival = leg?.arrival_time?.text || fmtTime(leg?.arrival_time?.value) || "-";
        const departure = leg?.departure_time?.text || fmtTime(leg?.departure_time?.value) || "-";
        const transfers = Math.max(0, steps.filter(s => s.travel_mode === "TRANSIT").length - 1);

        // 지도에 경로 그리기 (사람마다 다른 색)
        const renderer = new google.maps.DirectionsRenderer({
          map,
          directions: result,
          suppressMarkers: false,
          preserveViewport: true,
          polylineOptions: { strokeColor: ROUTE_COLORS[idx % ROUTE_COLORS.length], strokeOpacity: 0.8, strokeWeight: 5 }
        });
        directionsRenderers.push(renderer);

        card.innerHTML = `
  <div class="flex items-baseline justify-between mb-2">
    <div class="font-semibold text-gray-900">
      출발지 ${idx+1} · <span class="text-gray-700">${startLabel}</span>
    </div>
    <div class="text-sm text-gray-500">출발 ${departure || "-"} → 도착 ${arrival || "-"}</div>
  </div>
  <div class="mb-2">
    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-blue-50 text-blue-700 border border-blue-100">
      총 ${durationText || "-"}
    </span>
    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-indigo-50 text-indigo-700 border border-indigo-100 ml-1">
      환승 ${transfers}회
    </span>
  </div>
  <ol class="mt-2 space-y-1 text-gray-800 list-decimal pl-5">
    ${steps.map(stepToHTML).join("")}
  </ol>
        `;

        panel.appendChild(card);
        resolve();
      });
    }));

    await Promise.all(tasks);
  }

  // 버튼 클릭 연결
  document.getElementById("btnShowRoutes")?.addEventListener("click", (e) => {
    e.preventDefault();
    showRoutesForAll();
  });
</script>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCGgZQhmNH8ooriI05CeOi60AvlOcYTHPQ&libraries=places&callback=initMap"></script>
</body>
</html>
