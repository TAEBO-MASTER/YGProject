<!DOCTYPE html>
<html lang="ko">
<head>
    <!-- ê¸°ë³¸ íŒŒë¹„ì½˜ (fallback) -->
    <link rel="icon" href="/favicon.ico">

    <!-- ê³ í•´ìƒë„ íŒŒë¹„ì½˜ -->
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">

    <!-- iOS í™ˆí™”ë©´ ì•„ì´ì½˜ -->
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">

    <!-- ë¸Œë¼ìš°ì € í…Œë§ˆ ì»¬ëŸ¬(ëª¨ë°”ì¼ ì£¼ì†Œì°½ ìƒ‰ìƒ) -->
    <meta name="theme-color" content="#1f2937">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Where2Meet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        #map {
            height: 400px; /* ì§€ë„ì˜ ë†’ì´ ì„¤ì • */
            width: 100%;
            border-radius: 0.5rem; /* Tailwind rounded-lg */
            border: 1px solid #d1d5db; /* Tailwind border-gray-300 */
            margin-bottom: 1rem;
        }
        .info-window-content h3 {
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        .info-window-content p {
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem; /* leading-tight */
        }
        /* Custom styles for the slider labels to position them correctly */
        .slider-label-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.5rem; /* Adjust as needed */
            margin-bottom: 0.25rem;
        }

        /* Custom Alert/Message Box Styles */
        #customAlert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 1.5rem 2.5rem;
            border-radius: 0.75rem; /* rounded-xl */
            text-align: center;
            font-size: 1.25rem; /* text-xl */
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.3); /* shadow-lg */
            animation: fadeInOut 3s forwards; /* Animation for fade in and out */
            white-space: pre-wrap; /* Preserve whitespace and line breaks */
        }

        @keyframes fadeInOut {
            0% { opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* === ë¸Œëœë“œ & ê³µí†µ ë²„íŠ¼ ëª¨ì…˜ === */
        :root {
        --brand: #35AAF2;
        --brand-hov: #2C9CDA;
        --brand-bg: #E9F6FF;
        }

        /* ë²„íŠ¼ íŒ(íŠ€ëŠ”) ëª¨ì…˜ â€” ëª¨ë“  ë²„íŠ¼ ê³µí†µ */
        button, .btn-pop {
        transition: transform .18s ease, box-shadow .18s ease, background-color .18s ease, color .18s ease;
        }
        button:hover, .btn-pop:hover { transform: translateY(-1px) scale(1.02); box-shadow: 0 8px 20px rgba(53,170,242,.15); }
        button:active, .btn-pop:active { transform: translateY(0) scale(0.98); }

        /* ì•„ì›ƒë¼ì¸ íŒŒë‘ ë²„íŠ¼ìš© â€˜í™œì„±â€™ í‘œì‹œ(ì„ íƒë¨) */
        .btn-outline-active {
        background: var(--brand-bg) !important;
        box-shadow: inset 0 0 0 2px var(--brand);
        }

        /* === range(Î») ìŠ¬ë¼ì´ë” ìŠ¤íƒ€ì¼: íŠ¸ë™+ì¸ === */
        #lambdaSlider {
        -webkit-appearance: none; appearance: none; width: 100%; height: 8px;
        background: var(--brand-bg); border-radius: 9999px; outline: none;
        }
        #lambdaSlider::-webkit-slider-runnable-track {
        height: 8px; background: var(--brand-bg); border-radius: 9999px;
        }
        #lambdaSlider::-webkit-slider-thumb {
        -webkit-appearance: none; appearance: none;
        width: 20px; height: 20px; border-radius: 50%;
        background: var(--brand);
        border: 2px solid var(--brand-hov);
        margin-top: -6px; /* íŠ¸ë™ ê°€ìš´ë° ì •ë ¬ */
        transition: transform .15s ease, box-shadow .15s ease;
        box-shadow: 0 2px 6px rgba(53,170,242,.35);
        }
        #lambdaSlider:hover::-webkit-slider-thumb { transform: scale(1.06); }
        #lambdaSlider:active::-webkit-slider-thumb { transform: scale(0.95); }

        #lambdaSlider::-moz-range-track {
        height: 8px; background: var(--brand-bg); border-radius: 9999px;
        }
        #lambdaSlider::-moz-range-thumb {
        width: 20px; height: 20px; border-radius: 50%;
        background: var(--brand); border: 2px solid var(--brand-hov);
        transition: transform .15s ease, box-shadow .15s ease;
        box-shadow: 0 2px 6px rgba(53,170,242,.35);
        }
        #lambdaSlider:hover::-moz-range-thumb { transform: scale(1.06); }
        #lambdaSlider:active::-moz-range-thumb { transform: scale(0.95); }

    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl">
        <!-- ê´‘ê³  ì´ë¯¸ì§€ ì¶”ê°€ -->
        <!-- ê´‘ê³  ì´ë¯¸ì§€ + ë‹«ê¸° ë²„íŠ¼ -->
        <div id="adBanner" class="relative mb-6">
        <a href="https://www.skku.edu/skku/" target="_blank" class="block w-full rounded-lg">
            <img src="/static/skku_ad_banner.png" alt="ë‚´ ê´‘ê³  ë°°ë„ˆ"
                class="w-full h-auto object-cover rounded-lg">
        </a>
        <!-- ë‹«ê¸°(X) ë²„íŠ¼ -->
        <button type="button" aria-label="ë°°ë„ˆ ë‹«ê¸°"
                class="absolute -top-2 -right-2 bg-black/70 text-white rounded-full w-8 h-8
                        flex items-center justify-center hover:bg-black/80 shadow-md"
                onclick="closeAdBanner()">
            âœ•
        </button>
        </div>

<div class="mb-6 rounded-lg overflow-hidden">
        <div class="py-6 text-center flex items-center justify-center gap-3">
            <img src="/static/apple-touch-icon.png" alt="Where To Meet ë¡œê³ " class="h-12 w-auto">
            <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight title-shadow">
            <span style="color:#403635;">Where </span>
            <span style="color:#35AAF2;">To </span>
            <span style="color:#77CFF2;">Meet</span>
            </h1>
        </div>
        </div>


        <form id="locationForm" class="space-y-4">
            <div>
                <label for="map" class="block text-gray-700 text-sm font-semibold mb-2">
                    ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ì¶œë°œì§€ ìœ„ì¹˜ë¥¼ ì„ íƒí•˜ì„¸ìš” (ë§ˆì»¤ë¥¼ í´ë¦­í•˜ì—¬ ì œê±°)
                </label>
                <div id="map"></div>
                <input type="hidden" name="coords_json" id="coords_json">
            </div>
            <!-- ì§€ë„ ë°”ë¡œ ì•„ë˜: ì¥ì†Œ ê²€ìƒ‰ -->
            <div class="mt-2">
            <label for="placeSearch" class="sr-only">ì¥ì†Œ ê²€ìƒ‰</label>
            <!-- ì—¬ê¸° flexë¥¼ ë°˜ì‘í˜•ìœ¼ë¡œ: ëª¨ë°”ì¼ ì„¸ë¡œ, smë¶€í„° ê°€ë¡œ -->
            <div class="flex flex-col sm:flex-row gap-2 w-full">
                <input id="placeSearch" type="text" placeholder="ì¥ì†Œ ì´ë¦„ì´ë‚˜ ì£¼ì†Œë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”"
                class="min-w-0 flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-400"
                inputmode="search" enterkeyhint="search" />
                <button type="button" id="addFromSearchBtn"
  class="w-full sm:w-auto shrink-0 bg-white text-[#0D72C6] border border-[#35AAF2] rounded-lg px-4 py-2 font-bold
         hover:bg-[#E9F6FF] focus:outline-none focus:ring-2 focus:ring-[#35AAF2] focus:ring-offset-2 transition">
  ê²€ìƒ‰ìœ¼ë¡œ ì¶”ê°€
</button>


            </div>
            </div>



            <button type="button" id="useCurrentLocationBtn"
  class="w-full bg-white text-[#0D72C6] border border-[#35AAF2] rounded-lg px-4 py-2 font-bold mb-2
         hover:bg-[#E9F6FF] focus:outline-none focus:ring-2 focus:ring-[#35AAF2] focus:ring-offset-2 transition duration-300 ease-in-out transform hover:scale-105">
  ğŸ“ í˜„ìœ„ì¹˜ë¡œ ì…ë ¥
</button>



            <div id="currentLocationLoading" class="hidden text-center text-indigo-600 font-semibold mb-2">
                <!-- ìŠ¤í”¼ë„ˆ SVGì™€ í…ìŠ¤íŠ¸ë¥¼ <span>ìœ¼ë¡œ ê°ì‹¸ì„œ JSê°€ ì°¾ì„ ìˆ˜ ìˆë„ë¡ í•¨ -->
                <div class="flex items-center justify-center space-x-2">
                    <svg class="animate-spin h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>í˜„ìœ„ì¹˜ í™•ì¸ ì¤‘...</span> <!-- ì´ ë¶€ë¶„ì´ í•µì‹¬ ìˆ˜ì •: í…ìŠ¤íŠ¸ë¥¼ <span>ìœ¼ë¡œ ê°ìŒˆ -->
                </div>
            </div>

            <button type="button" id="resetBtn"
                class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2 transition duration-300 ease-in-out transform hover:scale-105 mb-4">
                ì§€ë„ ì´ˆê¸°í™”
            </button>



            <!-- ëŒë‹¤(ê°€ì¤‘ì¹˜) ìŠ¬ë¼ì´ë” -->
            <div class="mb-4">
                <label for="lambdaSlider" class="block text-gray-700 text-sm font-semibold mb-2">
                    <span class="block text-center mb-1">
                        ìµœì í™” ê¸°ì¤€ ì„ íƒ
                    </span>
                    
            <div class="slider-label-container">
            <button type="button" id="btnFair"
                    class="px-3 py-1 rounded-lg bg-white text-[#0D72C6] border border-[#35AAF2] font-bold btn-pop">
                í‰ë“±
            </button>
            <button type="button" id="btnEff"
                    class="px-3 py-1 rounded-lg bg-white text-[#0D72C6] border border-[#35AAF2] font-bold btn-pop">
                íš¨ìœ¨
            </button>
            </div>


                    <input type="range" id="lambdaSlider" name="lambda" min="0" max="1" step="0.1" value="0.5"
                           class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-lg">
                    <span class="block text-center text-lg font-medium text-gray-800 mt-1">
                        ê°€ì¤‘ì¹˜ (Î»): <span id="lambdaValue">0.5</span> <!-- ì´ˆê¸°ê°’ë„ 0.5ë¡œ ìˆ˜ì • -->
                    </span>
                </label>
            </div>

            <!-- ê²½ë¡œ ì„ í˜¸ (ì¥ì†Œ ì°¾ê¸° ì „ì— ì„ íƒ) -->
            <div class="mt-2 flex items-center gap-2">
            <label class="text-sm text-gray-600">ê²½ë¡œ ì„ í˜¸:</label>
            <select id="routePreference" name="transit_pref" class="border rounded px-2 py-1 text-sm">
                <option value="FEWER_TRANSFERS" selected>ìµœì†Œ í™˜ìŠ¹</option>
                <option value="LESS_WALKING">ìµœì†Œ ë„ë³´</option>
            </select>
            </div>

<button type="submit" id="submitBtn"
  class="w-full bg-white text-[#0D72C6] border border-[#35AAF2] rounded-lg px-4 py-3 font-bold
         focus:outline-none focus:ring-2 focus:ring-[#35AAF2] focus:ring-offset-2 hover:bg-[#E9F6FF] transition">
  ìµœì  ì¥ì†Œ ì°¾ê¸°
</button>





        </form>

        <div id="loadingIndicator" class="hidden text-center mt-4 text-blue-600 font-semibold">
            <div class="flex items-center justify-center space-x-2">
                <svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>ì¥ì†Œë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤...</span>
            </div>
        </div>

        <div id="resultsDisplay" class="mt-8 hidden">
            <!-- ê²°ê³¼ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>

            

        <div id="actionBar" class="mt-4">
<button id="btnShowRoutes" disabled
  class="w-full px-4 py-2 bg-white text-[#0D72C6] border border-[#35AAF2] rounded-lg font-bold
         hover:bg-[#E9F6FF] focus:outline-none focus:ring-2 focus:ring-[#35AAF2] disabled:opacity-50 transition">
  ê°œì¸ ê²½ë¡œ ìƒì„¸ ë³´ê¸°
</button>


</div>

<div id="routesPanel" class="mt-4 hidden"></div>


    <!-- Custom Alert/Message Box -->
    <div id="customAlert" class="hidden"></div>

    <script>
        let map;
        let originMarkers = []; // ì‚¬ìš©ìê°€ í´ë¦­í•˜ì—¬ ì¶”ê°€í•œ ì¶œë°œì§€ ë§ˆì»¤ ë°°ì—´
        let resultMarkers = []; // ìµœì  ì—­, ì¹´í˜ ë“± ê²°ê³¼ ë§ˆì»¤ ë°°ì—´
        let originCoords = []; // Flaskë¡œ ì „ì†¡ë  ìœ„ë„/ê²½ë„ ê°ì²´ ë°°ì—´
        let infoWindow; // ë§ˆì»¤ í´ë¦­ ì‹œ ì •ë³´ ì°½
        let directionsService; // ê²½ë¡œ ê²€ìƒ‰ ì„œë¹„ìŠ¤
        let directionsRenderers = []; // ê²½ë¡œ í‘œì‹œ ë Œë”ëŸ¬ ë°°ì—´ (ê° ì¶œë°œì§€ë§ˆë‹¤)
        let placesService; // ê²€ìƒ‰ìš© PlacesService
        let routePolylines = []; // ë²„ìŠ¤/ì§ì ‘ ëª¨ë“œì—ì„œ ê·¸ë¦° ì„ ë“¤ì„ ë‹´ì•„ë‘ëŠ” ë°°ì—´
        let selectedDestination = null;

        // --- ìƒíƒœ ì €ì¥/ë³µì›(LocalStorage) ---
const LS_KEY = 'w2m_state_v1';

function saveState() {
  try {
    if (!map) return;
    const c = map.getCenter();
    const payload = {
      origins: originCoords,                           // [{lat,lng}, ...]
      dest: selectedDestination,                       // {lat,lng} | null
      lambda: parseFloat(document.getElementById("lambdaSlider").value),
      pref: document.getElementById("routePreference").value,
      map: { center: { lat: c.lat(), lng: c.lng() }, zoom: map.getZoom() }
    };
    localStorage.setItem(LS_KEY, JSON.stringify(payload));
  } catch (e) { console.warn('saveState failed', e); }
}

function restoreState() {
  try {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return;
    const s = JSON.parse(raw);

    // UI ê°’
    if (s.lambda != null) {
      const slider = document.getElementById("lambdaSlider");
      const label  = document.getElementById("lambdaValue");
      slider.value = s.lambda;
      label.textContent = parseFloat(s.lambda).toFixed(1);
    }
    if (s.pref) {
      document.getElementById("routePreference").value = s.pref;
    }

    // ì§€ë„ ìœ„ì¹˜ (initMapì˜ ê¸°ë³¸ ì„¸íŒ… ì´í›„ í˜¸ì¶œë¨)
    if (s.map?.center && s.map?.zoom) {
      map.setCenter(s.map.center);
      map.setZoom(s.map.zoom);
    }

    // ì¶œë°œì§€ í•€ ë³µì›
    if (Array.isArray(s.origins)) {
      s.origins.forEach(pos => addOriginMarker(pos));
    }

    // ëª©ì ì§€ ë³µì› (ë§ˆì»¤ë§Œ)
    if (s.dest?.lat && s.dest?.lng) {
      selectedDestination = { lat: s.dest.lat, lng: s.dest.lng };
      const m = new google.maps.Marker({
        position: selectedDestination,
        map,
        icon: { url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png" },
        title: "ì´ì „ì— ì„ íƒí•œ ëª©ì ì§€"
      });
      resultMarkers.push(m);
      document.getElementById("btnShowRoutes")?.removeAttribute("disabled");
      // í•„ìš”í•˜ë©´ ìë™ìœ¼ë¡œ ê²½ë¡œ ë³µì›:
      // await showRoutesForAll();
    }
  } catch (e) { console.warn('restoreState failed', e); }
}


        // Function to show custom alert message
        function showCustomAlert(message) {
            const customAlert = document.getElementById("customAlert");
            customAlert.textContent = message;
            customAlert.classList.remove("hidden");
            // Set a timeout to hide the message after 3 seconds
            setTimeout(() => {
                customAlert.classList.add("hidden");
            }, 3000); 
        }

        function updateCoordsJson() {
            document.getElementById("coords_json").value = JSON.stringify(originCoords);
        }
        
        function initMap() {
            const seoul = { lat: 37.5665, lng: 126.9780 };
            map = new google.maps.Map(document.getElementById("map"), {
                center: seoul,
                zoom: 12,
                gestureHandling: "greedy"
            });
            map.addListener('idle', saveState);

            infoWindow = new google.maps.InfoWindow();
            directionsService = new google.maps.DirectionsService();

            // ì§€ë„ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ: í´ë¦­ ì‹œ ë§ˆì»¤ ì¶”ê°€ (LatLng ê°ì²´ë¥¼ ì¼ë°˜ ê°ì²´ë¡œ ë³€í™˜í•˜ì—¬ ì „ë‹¬)
            map.addListener("click", (e) => {
                addOriginMarker({ lat: e.latLng.lat(), lng: e.latLng.lng() });
            });

            document.getElementById("resetBtn").addEventListener("click", resetMap);
            document.getElementById("locationForm").addEventListener("submit", handleFormSubmit);
            document.getElementById("useCurrentLocationBtn").addEventListener("click", useCurrentLocation);
            document.getElementById("routePreference").addEventListener("change", saveState);
            document.getElementById("lambdaSlider").addEventListener("input", saveState);

            const lambdaSlider = document.getElementById("lambdaSlider");
            // í‰ë“±/íš¨ìœ¨ ë²„íŠ¼ â†” ìŠ¬ë¼ì´ë” ì—°ë™
            const btnFair = document.getElementById("btnFair");
            const btnEff  = document.getElementById("btnEff");

            function updateLambdaButtonsUI() {
            const v = parseFloat(lambdaSlider.value);
            // 0ìª½/1ìª½ì— ê°€ê¹Œìš°ë©´ í™œì„± í‘œì‹œ
            const fairOn = v <= 0.2, effOn = v >= 0.8;
            btnFair.classList.toggle("btn-outline-active", fairOn);
            btnEff.classList.toggle("btn-outline-active", effOn);
            }

            btnFair.addEventListener("click", () => {
            lambdaSlider.value = 0;
            lambdaValueSpan.textContent = "0.0";
            updateLambdaButtonsUI();
            if (typeof saveState === "function") saveState();
            });
            btnEff.addEventListener("click", () => {
            lambdaSlider.value = 1;
            lambdaValueSpan.textContent = "1.0";
            updateLambdaButtonsUI();
            if (typeof saveState === "function") saveState();
            });

            // ìŠ¬ë¼ì´ë”ë¥¼ ë“œë˜ê·¸í•´ë„ ë²„íŠ¼ ìƒíƒœ ë™ê¸°í™”
            lambdaSlider.addEventListener("input", updateLambdaButtonsUI);
            updateLambdaButtonsUI();


            const lambdaValueSpan = document.getElementById("lambdaValue");
            lambdaSlider.addEventListener("input", () => {
                lambdaValueSpan.textContent = parseFloat(lambdaSlider.value).toFixed(1);
            });
            // --- ê²€ìƒ‰ ìœ„ì ¯: ì§€ë„ ë°”ë¡œ ì•„ë˜ ì…ë ¥ì°½ ---
            const searchInput = document.getElementById("placeSearch");
            placesService = new google.maps.places.PlacesService(map);

            // ìë™ì™„ì„±: ë“œë¡­ë‹¤ìš´ ì„ íƒ ì‹œ ë°”ë¡œ ì¶”ê°€
            const autocomplete = new google.maps.places.Autocomplete(searchInput, {
            fields: ["place_id", "geometry", "name", "formatted_address"],
            componentRestrictions: { country: "kr" }
            });
            autocomplete.bindTo("bounds", map);

            autocomplete.addListener("place_changed", () => {
            const place = autocomplete.getPlace();
            if (!place || !place.geometry || !place.geometry.location) {
                if (searchInput.value.trim()) textSearchAdd(searchInput.value.trim());
                return;
            }
            const loc = place.geometry.location;
            const pos = { lat: loc.lat(), lng: loc.lng() };
            addOriginMarker(pos);
            map.panTo(pos);
            map.setZoom(14);
            searchInput.value = "";
            });

            // ì—”í„°í‚¤ë¡œë„ ì¶”ê°€(ìë™ì™„ì„± ë¯¸ì„ íƒ ëŒ€ë¹„)
            searchInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                if (searchInput.value.trim()) textSearchAdd(searchInput.value.trim());
            }
            });

            // ë²„íŠ¼ í´ë¦­ìœ¼ë¡œ ì¶”ê°€
            document.getElementById("addFromSearchBtn").addEventListener("click", () => {
            if (searchInput.value.trim()) textSearchAdd(searchInput.value.trim());
            });

            // í…ìŠ¤íŠ¸ ê²€ìƒ‰(ì²« ê²°ê³¼ë¥¼ ì¢Œí‘œë¡œ ë³€í™˜)
            function textSearchAdd(query) {
            placesService.textSearch(
                { query, location: map.getCenter(), radius: 50000 }, // í•„ìš”ì‹œ ë°˜ê²½ ì¡°ì •
                (results, status) => {
                if (status !== google.maps.places.PlacesServiceStatus.OK || !results?.length) {
                    alert("ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                    return;
                }
                const first = results[0];
                if (!first.geometry?.location) {
                    alert("ì´ ì¥ì†ŒëŠ” ì¢Œí‘œê°€ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }
                const loc = first.geometry.location;
                const pos = { lat: loc.lat(), lng: loc.lng() };
                addOriginMarker(pos);
                map.panTo(pos);
                map.setZoom(14);
                searchInput.value = "";
                }
            );
            }
          if (isBackForwardNav()) {
            restoreState();
            // ëª©ì ì§€ì™€ ì¶œë°œì§€ê°€ ìˆìœ¼ë©´ ê²½ë¡œë„ ìë™ ë³µì›
            if (originCoords.length && selectedDestination) {
            showRoutesForAll();
            }
        } else {
            // ìƒˆ ë°©ë¬¸/ìƒˆíƒ­/ì§ì ‘ URL ì§„ì… ë“±ì€ ë³µì›í•˜ì§€ ì•ŠìŒ(2ë²ˆ ìš”êµ¬)
            try { localStorage.removeItem(LS_KEY); } catch {}
        }
        }
        // ë’¤ë¡œ/ì•ìœ¼ë¡œ íƒìƒ‰ ê°ì§€ ìœ í‹¸
        function isBackForwardNav() {
        try {
            const nav = performance.getEntriesByType('navigation')?.[0];
            return nav && nav.type === 'back_forward';
        } catch { return false; }
        }
        function resetMap() {
            // 0) UI ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”
            const slider = document.getElementById("lambdaSlider");
            const lambdaValueSpan = document.getElementById("lambdaValue");
            slider.value = 0.5;
            lambdaValueSpan.textContent = "0.5";
            document.getElementById("routePreference").value = "FEWER_TRANSFERS";
            document.getElementById("placeSearch").value = "";
            document.getElementById("coords_json").value = "[]";
            document.getElementById("loadingIndicator").classList.add("hidden");
            document.getElementById("customAlert")?.classList.add("hidden");

            // 1) ì§€ë„ ì˜¤ë²„ë ˆì´/ë§ˆì»¤/ë Œë”ëŸ¬ ì „ë¶€ ì œê±°
            clearResultMarkers();      // ê²°ê³¼ ë§ˆì»¤ + directionsRenderers + routePolylines + infoWindow ë‹«í˜
            clearOriginMarkers();      // ì¶œë°œì§€ ë§ˆì»¤ + originCoords ë¹„ì›€

            // í˜¹ì‹œ ë‚¨ì•˜ì„ ìˆ˜ë„ ìˆëŠ” ë Œë”ëŸ¬/í´ë¦¬ë¼ì¸ë„ í•œë²ˆ ë” ì•ˆì „í•˜ê²Œ ì •ë¦¬
            for (const r of directionsRenderers) r.setMap(null);
            directionsRenderers = [];
            for (const pl of routePolylines) pl.setMap(null);
            routePolylines = [];
            if (infoWindow) infoWindow.close();

            // 2) ê²°ê³¼ íŒ¨ë„/ë²„íŠ¼ ì´ˆê¸°í™”
            const results = document.getElementById("resultsDisplay");
            results.innerHTML = "";
            results.classList.add("hidden");

            const panel = document.getElementById("routesPanel");
            panel.innerHTML = "";
            panel.classList.add("hidden");

            const btn = document.getElementById("btnShowRoutes");
            btn.setAttribute("disabled", "disabled");

            // 3) ìƒíƒœ ë³€ìˆ˜ ì´ˆê¸°í™”
            selectedDestination = null;

            // 4) ì§€ë„ ìœ„ì¹˜ ì´ˆê¸°í™”
            const seoul = { lat: 37.5665, lng: 126.9780 };
            map.setCenter(seoul);
            map.setZoom(12);

            // 5) ë¡œì»¬ ì €ì¥ ìƒíƒœë„ 'ë¹ˆ ìƒíƒœ'ë¡œ ë®ì–´ì“°ê¸°
            //  - ì™„ì „íˆ ì—†ì• ê³  ì‹¶ìœ¼ë©´ removeItem(LS_KEY) ì‚¬ìš©í•´ë„ ë˜ì§€ë§Œ,
            //    ì´ˆê¸°í™”ëœ ë¹ˆ ìƒíƒœë¥¼ ì €ì¥í•´ë‘ëŠ” í¸ì´ ë’¤ë¡œ ì˜¤ê¸°/ìƒˆë¡œê³ ì¹¨ ì‹œì—ë„ ê¹¨ë—í•©ë‹ˆë‹¤.
            try {
                if (typeof saveState === "function") {
                saveState();               // ë¹ˆ ìƒíƒœ ì €ì¥(ê¶Œì¥)
                // ë˜ëŠ” ì•„ë˜ í•œ ì¤„ë¡œ ì™„ì „ ì‚­ì œ:
                // localStorage.removeItem(LS_KEY);
                }
            } catch (e) {
                console.warn("state reset failed", e);
            }
        }


        function useCurrentLocation() {
            const loadingIndicatorDiv = document.getElementById("currentLocationLoading");
            const loadingTextSpan = loadingIndicatorDiv.querySelector("span");
            const spinnerSvg = loadingIndicatorDiv.querySelector("svg");

            // ì´ˆê¸° ìƒíƒœ: 'í˜„ìœ„ì¹˜ í™•ì¸ ì¤‘...' ë¬¸êµ¬ í‘œì‹œ
            loadingTextSpan.textContent = "í˜„ìœ„ì¹˜ í™•ì¸ ì¤‘...";
            spinnerSvg.classList.remove("hidden"); // ìŠ¤í”¼ë„ˆ í‘œì‹œ
            loadingIndicatorDiv.classList.remove("hidden"); // ë¡œë”© ì¸ë””ì¼€ì´í„° í‘œì‹œ

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };
                        addOriginMarker(pos); // í•€ ì¶”ê°€ í•¨ìˆ˜ í˜¸ì¶œ
                        map.panTo(pos);
                        map.setZoom(14);

                        // âœ¨ ìˆ˜ì •ëœ ë¶€ë¶„: í•€ ì¶”ê°€ ë° ì§€ë„ ì—…ë°ì´íŠ¸ ì§í›„ 'ì…ë ¥ ì™„ë£Œ' ë©”ì‹œì§€ë¡œ ë³€ê²½
                        spinnerSvg.classList.add("hidden"); // ìŠ¤í”¼ë„ˆ ìˆ¨ê¹€
                        loadingTextSpan.textContent = "í˜„ìœ„ì¹˜ ì…ë ¥ ì™„ë£Œ! âœ…";
                        
                        // ê·¸ ë‹¤ìŒ 5ì´ˆ ë’¤ ë¡œë”© ì¸ë””ì¼€ì´í„°ë¥¼ ìˆ¨ê¹€
                        setTimeout(() => {
                            loadingIndicatorDiv.classList.add("hidden");
                        }, 5000); // "ì…ë ¥ ì™„ë£Œ" ë©”ì‹œì§€ê°€ 2ì´ˆê°„ ë³´ì¸ í›„ ì‚¬ë¼ì§
                    },
                    (error) => {
                        // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¦‰ì‹œ ìˆ¨ê¹€
                        loadingIndicatorDiv.classList.add("hidden");
                        let errorMessage = "í˜„ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = "ìœ„ì¹˜ ì •ë³´ ì‚¬ìš© ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ìœ„ì¹˜ ì •ë³´ ì ‘ê·¼ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = "ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
                                break;
                            case error.TIMEOUT:
                                errorMessage = "ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ì•ˆì •ì ì¸ ë„¤íŠ¸ì›Œí¬ì—ì„œ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
                                break;
                        }
                        alert(errorMessage);
                        console.error("Geolocation Error:", error);
                    }
                );
            } else {
                // ë¸Œë¼ìš°ì €ê°€ ì§€ì›í•˜ì§€ ì•Šì„ ê²½ìš° ì¦‰ì‹œ ìˆ¨ê¹€
                loadingIndicatorDiv.classList.add("hidden");
                alert("ì´ ë¸Œë¼ìš°ì €ëŠ” í˜„ìœ„ì¹˜ ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }
        }

        function addOriginMarker(location) {
             if (location.lat <= -60) {
                showCustomAlert("í˜¹ì‹œ í­ê·„ì´ì‹ ê°€ìš”? ğŸ§");
            }
            // ì´ì œ locationì€ í•­ìƒ {lat: value, lng: value} í˜•íƒœì˜ ì¼ë°˜ ê°ì²´ì´ë¯€ë¡œ .lat, .lngë¡œ ì§ì ‘ ì ‘ê·¼
            const isDuplicate = originCoords.some(coord =>
                Math.abs(coord.lat - location.lat) < 1e-6 && Math.abs(coord.lng - location.lng) < 1e-6
            );

            if (isDuplicate) {
                console.log("ë™ì¼í•œ ìœ„ì¹˜ì— í•€ì„ ì¶”ê°€í•˜ë ¤ëŠ” ì‹œë„ë¥¼ ë¬´ì‹œí•©ë‹ˆë‹¤.");
                return; // ì¤‘ë³µì´ë©´ ì¶”ê°€í•˜ì§€ ì•Šê³  í•¨ìˆ˜ ì¢…ë£Œ
            }

            const marker = new google.maps.Marker({
                position: location, // locationì€ ì´ë¯¸ {lat, lng} í˜•íƒœì´ë¯€ë¡œ ê·¸ëŒ€ë¡œ ì‚¬ìš© ê°€ëŠ¥
                map: map,
                icon: {
                    url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png"
                },
                clickable: true // ë§ˆì»¤ í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
            });

            originMarkers.push(marker);
            originCoords.push({ lat: location.lat, lng: location.lng }); // âœ¨ ìˆ˜ì •ëœ ë¶€ë¶„: location.lat(), location.lng() -> location.lat, location.lng
            updateCoordsJson(); // hidden input ì—…ë°ì´íŠ¸
            saveState();

            // **ìƒˆë¡œìš´ ê¸°ëŠ¥: ë§ˆì»¤ í´ë¦­ ì‹œ ê°œë³„ ì‚­ì œ**
            marker.addListener("click", () => {
                // ì´ ë§ˆì»¤ê°€ originMarkers ë°°ì—´ì˜ ëª‡ ë²ˆì§¸ì¸ì§€ ì°¾ìŠµë‹ˆë‹¤.
                const index = originMarkers.indexOf(marker);
                if (index > -1) {
                    // ì§€ë„ì—ì„œ ë§ˆì»¤ ì œê±°
                    marker.setMap(null);

                    // ë°°ì—´ì—ì„œ ë§ˆì»¤ì™€ í•´ë‹¹ ì¢Œí‘œ ì œê±°
                    originMarkers.splice(index, 1);
                    originCoords.splice(index, 1);

                    updateCoordsJson(); // hidden input ì—…ë°ì´íŠ¸
                    console.log("ë§ˆì»¤ê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤. í˜„ì¬ ì„ íƒëœ ì¶œë°œì§€ ì¢Œí‘œ:", originCoords);

                    // ë§Œì•½ ì´ ë§ˆì»¤ì˜ ì •ë³´ì°½ì´ ì—´ë ¤ìˆë‹¤ë©´ ë‹«ìŠµë‹ˆë‹¤.
                    if (infoWindow && infoWindow.getMap() === map) {
                        infoWindow.close();
                    }
                }
            });

            console.log("í˜„ì¬ ì„ íƒëœ ì¶œë°œì§€ ì¢Œí‘œ:", originCoords);
        }

        function clearOriginMarkers() {
            for (let i = 0; i < originMarkers.length; i++) {
                originMarkers[i].setMap(null); // ì§€ë„ì—ì„œ ëª¨ë“  ë§ˆì»¤ ì œê±°
            }
            originMarkers = []; // ë§ˆì»¤ ë°°ì—´ ë¹„ìš°ê¸°
            originCoords = []; // ì¢Œí‘œ ë°°ì—´ ë¹„ìš°ê¸°
            updateCoordsJson(); // hidden input ì—…ë°ì´íŠ¸
            console.log("ëª¨ë“  ì¶œë°œì§€ í•€ì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.");
            saveState();
        }

        function clearResultMarkers() {
        // ê²°ê³¼ ë§ˆì»¤ ì œê±°
        for (let i = 0; i < resultMarkers.length; i++) {
            resultMarkers[i].setMap(null);
        }
        resultMarkers = [];

        // ê²½ë¡œ ë Œë”ëŸ¬ ì œê±°(ëŒ€ì¤‘êµí†µ ê²½ë¡œ)
        for (let i = 0; i < directionsRenderers.length; i++) {
            directionsRenderers[i].setMap(null);
        }
        directionsRenderers = [];

        // ì§ì ‘ ê·¸ë¦° í´ë¦¬ë¼ì¸(ë²„ìŠ¤/ì§ì ‘ ëª¨ë“œ) ì œê±°
        for (let i = 0; i < routePolylines.length; i++) {
            routePolylines[i].setMap(null);
        }
        routePolylines = [];

        if (infoWindow) {
            infoWindow.close();
        }
        saveState();
        }


        async function handleFormSubmit(event) {
            event.preventDefault();

            if (originCoords.length === 0) {
                alert("ìµœì†Œ í•˜ë‚˜ ì´ìƒì˜ ì¶œë°œì§€ ìœ„ì¹˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            clearResultMarkers();
            document.getElementById("resultsDisplay").classList.add("hidden");
            document.getElementById("loadingIndicator").classList.remove("hidden");

            const formEl = document.getElementById("locationForm");
            const formData = new FormData(formEl);
            formData.set("coords_json", JSON.stringify(originCoords));
            formData.set("lambda", document.getElementById("lambdaSlider").value);
            formData.set("transit_pref", document.getElementById("routePreference").value);

            try {
                const response = await fetch('/api/find_places', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    displayResultsOnMap(result);
                    displayResultsText(result);
                    if (selectedDestination) {
                        document.getElementById('btnShowRoutes').removeAttribute('disabled');
                        await showRoutesForAll();
                        document.getElementById('routesPanel').scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                } else {
                    alert(`ì˜¤ë¥˜: ${result.error || result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}`);
                    console.error("API Error:", result);
                    document.getElementById("resultsDisplay").innerHTML = `<p class="text-red-600 text-lg font-medium text-center p-4 bg-red-50 rounded-lg border border-red-200">
                                                                            ì˜¤ë¥˜: ${result.error || result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}
                                                                          </p>`;
                    document.getElementById("resultsDisplay").classList.remove("hidden");
                }
            } catch (error) {
                console.error("Fetch Error:", error);
                alert("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ì‘ë‹µ ë¬¸ì œ ë°œìƒ!");
                document.getElementById("resultsDisplay").innerHTML = `<p class="text-red-600 text-lg font-medium text-center p-4 bg-red-50 rounded-lg border border-red-200">
                                                                        ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ì‘ë‹µ ë¬¸ì œ ë°œìƒ: ${error.message}
                                                                      </p>`;
                document.getElementById("resultsDisplay").classList.remove("hidden");
            } finally {
                document.getElementById("loadingIndicator").classList.add("hidden");
            }
        }

        function displayResultsOnMap(data) {
            const bounds = new google.maps.LatLngBounds();
            originMarkers.forEach(marker => bounds.extend(marker.getPosition())); // Always include origin markers

            // Handle results based on result_type
            let mainPlacePos = null;
            let mainPlaceTitle = "";
            let mainPlaceIcon = "";
            let mainPlaceContent = "";

            if (data.result_type === "transit_station" && data.best_station) {
                mainPlacePos = { lat: data.best_station.lat, lng: data.best_station.lng };
                selectedDestination = mainPlacePos;
                document.getElementById("btnShowRoutes")?.removeAttribute("disabled");
                saveState();

                mainPlaceTitle = data.best_station.name;
                mainPlaceIcon = "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"; // Blue for transit station
                mainPlaceContent = `
                    <div class="info-window-content">
                        <h3>ğŸ“ ìµœì  ë¯¸íŒ…ì—­: ${data.best_station.name}</h3>
                        <p>í‰ê·  ì´ë™ ì‹œê°„: ${data.best_station.avg_min.toFixed(1)}ë¶„</p>
                        <p>ìµœëŒ€ ì´ë™ ì‹œê°„: ${data.best_station.max_min.toFixed(1)}ë¶„</p>
                `;
                if (data.best_station.times && data.best_station.times.length > 0) {
                    mainPlaceContent += `<p>ê°œë³„ ì´ë™ ì‹œê°„ (ì¼ë¶€):</p><ul>`;
                    const timesToShow = data.best_station.times.slice(0, Math.min(data.best_station.times.length, 3));
                    timesToShow.forEach((time, index) => {
                        mainPlaceContent += `<li>ì¶œë°œì§€ ${index + 1}: ${time.toFixed(1)}ë¶„</li>`;
                    });
                    mainPlaceContent += `</ul>`;
                }
                mainPlaceContent += `</div>`;

                // Draw transit routes  âœ… ì •ìƒ ë²„ì „(ì§€ë„ ì„ ë§Œ)
                originMarkers.forEach((originMarker, index) => {
                const pref = document.getElementById("routePreference")?.value;
                const routingPreference = (pref === "LESS_WALKING")
                    ? google.maps.TransitRoutePreference.LESS_WALKING
                    : google.maps.TransitRoutePreference.FEWER_TRANSFERS;

                const request = {
                    origin: originMarker.getPosition(),
                    destination: mainPlacePos, // ì´ ìŠ¤ì½”í”„ì—ì„œë§Œ ì“°ëŠ” ëª©ì ì§€
                    travelMode: google.maps.TravelMode.TRANSIT,
                    transitOptions: { routingPreference, departureTime: new Date() },
                    region: "KR"
                };

                directionsService.route(request, (result, status) => {
                    if (status === google.maps.DirectionsStatus.OK) {
                    const dr = new google.maps.DirectionsRenderer({
                        map,
                        suppressMarkers: true,
                        polylineOptions: { strokeColor: 'blue', strokeOpacity: 0.6, strokeWeight: 4 }
                    });
                    dr.setDirections(result);
                    directionsRenderers.push(dr);
                    } else {
                    console.error(`ì¶œë°œì§€ ${index + 1} ê²½ë¡œ ì‹¤íŒ¨: ${status}`);
                    }
                });
            });


            } else if (data.result_type === "bus_terminal" && data.best_bus_terminal) {
                mainPlacePos = { lat: data.best_bus_terminal.lat, lng: data.best_bus_terminal.lng };
                selectedDestination = mainPlacePos;
                document.getElementById("btnShowRoutes")?.removeAttribute("disabled");
                saveState();

                mainPlaceTitle = data.best_bus_terminal.name;
                mainPlaceIcon = "http://maps.google.com/mapfiles/ms/icons/orange-dot.png"; // Orange for bus terminal
                mainPlaceContent = `
                    <div class="info-window-content">
                        <h3>ğŸšŒ ìµœì  ë²„ìŠ¤ í„°ë¯¸ë„: ${data.best_bus_terminal.name}</h3>
                        <p>ì¤‘ì‹¬ ì§€ì ìœ¼ë¡œë¶€í„° ê±°ë¦¬: ${data.best_bus_terminal.distance_km.toFixed(2)} km</p>
                    </div>
                `;
                // Draw simple lines for bus terminal (Directions API transit mode may be limited for bus)
                originMarkers.forEach((originMarker, index) => {
                     const line = new google.maps.Polyline({
                        path: [originMarker.getPosition(), mainPlacePos],
                        geodesic: true,
                        strokeColor: '#FF9800', // í˜¹ì€ '#800080' (ì§ì ‘ ëª¨ë“œ)
                        strokeOpacity: 0.6,
                        strokeWeight: 2,
                        map: map
                        });
                        routePolylines.push(line);

                });

            } else if (data.result_type === "direct_places" && (data.direct_nearby_places_cafes.length > 0 || data.direct_nearby_places_study_cafes.length > 0)) {
                mainPlacePos = { lat: data.best_point.lat, lng: data.best_point.lng };
                mainPlaceTitle = "ìµœì  ì¤‘ì‹¬ ì§€ì ";
                mainPlaceIcon = "http://maps.google.com/mapfiles/ms/icons/purple-dot.png"; // Purple for direct places center
                mainPlaceContent = `
                    <div class="info-window-content">
                        <h3>âœ¨ ìµœì  ì¤‘ì‹¬ ì§€ì </h3>
                        <p>ì—­/í„°ë¯¸ë„ ëŒ€ì‹  ì´ ì£¼ë³€ì—ì„œ ë§Œë‚¨ì„ ê³ ë ¤í•´ë³´ì„¸ìš”.</p>
                    </div>
                `;
                selectedDestination = mainPlacePos;
                document.getElementById("btnShowRoutes")?.removeAttribute("disabled");
                saveState();

                 // Draw simple lines to best point
                originMarkers.forEach((originMarker, index) => {
                     new google.maps.Polyline({
                        path: [originMarker.getPosition(), mainPlacePos],
                        geodesic: true,
                        strokeColor: '#800080',
                        strokeOpacity: 0.6,
                        strokeWeight: 2,
                        map: map
                    });
                });
            }

            // Add main place marker if found
            if (mainPlacePos) {
                const mainPlaceMarker = new google.maps.Marker({
                    position: mainPlacePos,
                    map: map,
                    icon: { url: mainPlaceIcon },
                    title: mainPlaceTitle
                });
                resultMarkers.push(mainPlaceMarker);
                bounds.extend(mainPlacePos);
                mainPlaceMarker.addListener("click", () => {
                    infoWindow.setContent(mainPlaceContent);
                    infoWindow.open(map, mainPlaceMarker);
                });
            }
            
            // Add nearby cafes (green dot)
            const cafesToDisplay = data.cafes_list || data.direct_nearby_places_cafes || [];
            cafesToDisplay.forEach(cafe => {
                const cafePos = { lat: cafe.lat, lng: cafe.lng };
                const cafeMarker = new google.maps.Marker({
                    position: cafePos,
                    map: map,
                    icon: { url: "https://maps.google.com/mapfiles/ms/icons/green-dot.png" },
                    title: cafe.name
                });
                resultMarkers.push(cafeMarker);
                bounds.extend(cafePos);

                const cafeContent = `
                    <div class="info-window-content">
                        <h3>â˜• ì¹´í˜: ${cafe.name}</h3>
                        <p>ê±°ë¦¬: ${cafe.distance_km.toFixed(2)} km</p>
                    </div>
                `;
                cafeMarker.addListener("click", () => {
                    infoWindow.setContent(cafeContent);
                    infoWindow.open(map, cafeMarker);
                    selectedDestination = cafePos;
                    document.getElementById("btnShowRoutes")?.removeAttribute("disabled");
                    saveState();

                });
            });

            // Add nearby study cafes (yellow dot)
            const studyCafesToDisplay = data.study_cafes_list || data.direct_nearby_places_study_cafes || [];
            studyCafesToDisplay.forEach(studyCafe => {
                const studyCafePos = { lat: studyCafe.lat, lng: studyCafe.lng };
                const studyCafeMarker = new google.maps.Marker({
                    position: studyCafePos,
                    map: map,
                    icon: { url: "http://maps.google.com/mapfiles/ms/icons/yellow-dot.png" },
                    title: studyCafe.name
                });
                resultMarkers.push(studyCafeMarker);
                bounds.extend(studyCafePos);

                const studyCafeContent = `
                    <div class="info-window-content">
                        <h3>ğŸ“š ìŠ¤í„°ë””ì¹´í˜: ${studyCafe.name}</h3>
                        <p>ê±°ë¦¬: ${studyCafe.distance_km.toFixed(2)} km</p>
                    

                    </div>
                `;
                studyCafeMarker.addListener("click", () => {
                    infoWindow.setContent(studyCafeContent);
                    infoWindow.open(map, studyCafeMarker);
                    selectedDestination = studyCafePos;
                    document.getElementById("btnShowRoutes")?.removeAttribute("disabled");
                    saveState();
                });
            });

            if (data.result_type === "no_places_found" || data.error) {
                console.warn("No places found or an error occurred. Map will only show origin markers.");
            }
            map.fitBounds(bounds);
        }

        // âœ… ìµœì  ì¥ì†Œ ê¸°ì¤€, ë°±ì—”ë“œ APIë¡œ ì£¼ë³€ ìŠ¤í„°ë””ì¹´í˜(ê±°ë¦¬ìˆœ) ê°€ì ¸ì˜¤ê¸° â†’ ìƒìœ„ 5ê°œë§Œ
        async function loadStudyCafesTop5(centerLatLng) {
        const lat = typeof centerLatLng.lat === 'function' ? centerLatLng.lat() : centerLatLng.lat;
        const lng = typeof centerLatLng.lng === 'function' ? centerLatLng.lng() : centerLatLng.lng;
        const radius = 1500; // "ì£¼ë³€" ì •ì˜(1.5km). í•„ìš”í•˜ë©´ 1000~2000më¡œ ì¡°ì ˆ
        const r = await fetch(`/api/nearby_studycafes?lat=${lat}&lng=${lng}&radius=${radius}`);
        const d = await r.json();
        if (!r.ok || !d?.ok) throw new Error(d.error || "ìŠ¤í„°ë””ì¹´í˜ ê²€ìƒ‰ ì‹¤íŒ¨");
        return (d.results || []).slice(0, 5);
        }

        

        async function displayResultsText(data) {
            const resultsDisplay = document.getElementById("resultsDisplay");
            let htmlContent = '';

            if (data.error) {
                htmlContent += `
                    <p class="text-red-600 text-lg font-medium text-center p-4 bg-red-50 rounded-lg border border-red-200">
                        ì˜¤ë¥˜: ${data.error}
                    </p>
                `;
            } else if (data.result_type === "transit_station" && data.best_station) {
                htmlContent += `
                    <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <h2 class="text-2xl font-semibold text-blue-800 mb-3">ğŸ“ ìµœì  ë¯¸íŒ…ì—­ (ì§€í•˜ì² /ê¸°ì°¨)</h2>
                        <p class="text-lg text-gray-700 mb-2"><strong>ì´ë¦„:</strong> ${data.best_station.name}</p>
                        <p class="text-lg text-gray-700 mb-2"><strong>ìœ„ì¹˜:</strong> ${data.best_station.lat.toFixed(6)}, ${data.best_station.lng.toFixed(6)}</p>
                        <p class="text-lg text-gray-700 mb-2"><strong>í‰ê·  ì´ë™ ì‹œê°„:</strong> ${data.best_station.avg_min.toFixed(1)}ë¶„</p>
                        <p class="text-lg text-gray-700 mb-2"><strong>ìµœëŒ€ ì´ë™ ì‹œê°„:</strong> ${data.best_station.max_min.toFixed(1)}ë¶„</p>
                `;
                if (data.best_station.times && data.best_station.times.length > 0) {
                    htmlContent += `<h3 class="text-xl font-semibold text-blue-700 mt-4 mb-2">ê° ì¶œë°œì§€ì—ì„œ ì—­ê¹Œì§€ ì´ë™ ì‹œê°„:</h3>`;
                    htmlContent += `<ul class="list-disc pl-5 space-y-1 text-gray-700">`;
                    data.best_station.times.forEach((time, index) => {
                        htmlContent += `<li>ì¶œë°œì§€ ${index + 1}: ${time.toFixed(1)}ë¶„</li>`;
                    });
                    htmlContent += `</ul>`;
                }
                htmlContent += `</div>`;

                // Display Cafes
                if (data.cafes_list && data.cafes_list.length > 0) {
                    htmlContent += `
                        <div class="mb-6 p-4 bg-green-50 rounded-lg border border-green-200">
                            <h2 class="text-2xl font-semibold text-green-800 mb-3">â˜• ì£¼ë³€ ì¹´í˜ (ìƒìœ„ 5ê°œ)</h2>
                            <ul class="list-disc pl-5 space-y-2 text-gray-700">
                    `;
                    data.cafes_list.forEach(cafe => {
                        htmlContent += `
                                <li>
                                    <strong>${cafe.name}</strong> (ê±°ë¦¬: ${cafe.distance_km.toFixed(2)} km)
                                    <span class="text-sm text-gray-500">(${cafe.lat.toFixed(6)}, ${cafe.lng.toFixed(6)})</span>
                                </li>
                        `;
                    });
                    htmlContent += `
                            </ul>
                        </div>
                    `;
                }

                // ğŸ“š ì£¼ë³€ ìŠ¤í„°ë””ì¹´í˜ (ìƒìœ„ 5ê°œ) â€” ë°±ì—”ë“œ API ê²°ê³¼ ì‚¬ìš©(ê±°ë¦¬ìˆœ+ì´ë¦„í•„í„° ì¼ê´€)
                htmlContent += `
                <div class="mb-6 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                    <h2 class="text-2xl font-semibold text-yellow-800 mb-3">ğŸ“š ì£¼ë³€ ìŠ¤í„°ë””ì¹´í˜ (ìƒìœ„ 5ê°œ)</h2>
                    <ul class="list-disc pl-5 space-y-2 text-gray-700">`;

                try {
                const cafes = await loadStudyCafesTop5({ lat: data.best_station.lat, lng: data.best_station.lng });
                if (!cafes.length) {
                    htmlContent += `<li class="text-gray-500">ì£¼ë³€ì— ìŠ¤í„°ë””ì¹´í˜ê°€ ì—†ìŠµë‹ˆë‹¤.</li>`;
                } else {
                    cafes.forEach(sc => {
                    const dkm = (typeof sc.distance_km === 'number') ? sc.distance_km.toFixed(2) : '-';
                    const la = sc.location?.lat ?? sc.lat;
                    const ln = sc.location?.lng ?? sc.lng;
                    htmlContent += `
                        <li>
                        <strong>${sc.name}</strong> (ê±°ë¦¬: ${dkm} km)
                        <span class="text-sm text-gray-500">(${la?.toFixed?.(6) ?? ''}, ${ln?.toFixed?.(6) ?? ''})</span>
                        </li>`;
                    });
                }
                } catch (e) {
                htmlContent += `<li class="text-red-600">ìŠ¤í„°ë””ì¹´í˜ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${e.message}</li>`;
                }

                htmlContent += `</ul></div>`;


                if (!(data.cafes_list && data.cafes_list.length > 0) && !(data.study_cafes_list && data.study_cafes_list.length > 0)) {
                    htmlContent += `
                        <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <h2 class="text-2xl font-semibold text-gray-800 mb-3">â˜• ì£¼ë³€ ì¥ì†Œ</h2>
                            <p class="text-gray-700">ì£¼ë³€ì— ì°¾ì„ ìˆ˜ ìˆëŠ” ì¹´í˜ë‚˜ ìŠ¤í„°ë””ì¹´í˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                    `;
                }

            } else if (data.result_type === "bus_terminal" && data.best_bus_terminal) {
                htmlContent += `
                    <div class="mb-6 p-4 bg-orange-50 rounded-lg border border-orange-200">
                        <h2 class="text-2xl font-semibold text-orange-800 mb-3">ğŸšŒ ìµœì  ë¯¸íŒ… ë²„ìŠ¤ í„°ë¯¸ë„</h2>
                        <p class="text-lg text-gray-700 mb-2"><strong>ì´ë¦„:</strong> ${data.best_bus_terminal.name}</p>
                        <p class="text-lg text-gray-700 mb-2"><strong>ìœ„ì¹˜:</strong> ${data.best_bus_terminal.lat.toFixed(6)}, ${data.best_bus_terminal.lng.toFixed(6)}</p>
                        <p class="text-lg text-gray-700 mb-2"><strong>ì¤‘ì‹¬ ì§€ì ìœ¼ë¡œë¶€í„° ê±°ë¦¬:</strong> ${data.best_bus_terminal.distance_km.toFixed(2)} km</p>
                    </div>
                `;

                
                // Display Cafes for bus terminal
                if (data.cafes_list && data.cafes_list.length > 0) {
                    htmlContent += `
                        <div class="mb-6 p-4 bg-green-50 rounded-lg border border-green-200">
                            <h2 class="text-2xl font-semibold text-green-800 mb-3">â˜• ì£¼ë³€ ì¹´í˜ (ìƒìœ„ 5ê°œ)</h2>
                            <ul class="list-disc pl-5 space-y-2 text-gray-700">
                    `;
                    data.cafes_list.forEach(cafe => {
                        htmlContent += `
                                <li>
                                    <strong>${cafe.name}</strong> (ê±°ë¦¬: ${cafe.distance_km.toFixed(2)} km)
                                    <span class="text-sm text-gray-500">(${cafe.lat.toFixed(6)}, ${cafe.lng.toFixed(6)})</span>
                                </li>
                        `;
                    });
                    htmlContent += `
                            </ul>
                        </div>
                    `;
                }
                
                // ğŸ“š ì£¼ë³€ ìŠ¤í„°ë””ì¹´í˜ (ìƒìœ„ 5ê°œ) â€” ë°±ì—”ë“œ API ê²°ê³¼ ì‚¬ìš©(ê±°ë¦¬ìˆœ+ì´ë¦„í•„í„° ì¼ê´€)
                    htmlContent += `
                    <div class="mb-6 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                        <h2 class="text-2xl font-semibold text-yellow-800 mb-3">ğŸ“š ì£¼ë³€ ìŠ¤í„°ë””ì¹´í˜ (ìƒìœ„ 5ê°œ)</h2>
                        <ul class="list-disc pl-5 space-y-2 text-gray-700">`;

                    try {
                    const cafes = await loadStudyCafesTop5({ lat: data.best_station.lat, lng: data.best_station.lng });
                    if (!cafes.length) {
                        htmlContent += `<li class="text-gray-500">ì£¼ë³€ì— ìŠ¤í„°ë””ì¹´í˜ê°€ ì—†ìŠµë‹ˆë‹¤.</li>`;
                    } else {
                        cafes.forEach(sc => {
                        const dkm = (typeof sc.distance_km === 'number') ? sc.distance_km.toFixed(2) : '-';
                        const la = sc.location?.lat ?? sc.lat;
                        const ln = sc.location?.lng ?? sc.lng;
                        htmlContent += `
                            <li>
                            <strong>${sc.name}</strong> (ê±°ë¦¬: ${dkm} km)
                            <span class="text-sm text-gray-500">(${la?.toFixed?.(6) ?? ''}, ${ln?.toFixed?.(6) ?? ''})</span>
                            </li>`;
                        });
                    }
                    } catch (e) {
                    htmlContent += `<li class="text-red-600">ìŠ¤í„°ë””ì¹´í˜ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${e.message}</li>`;
                    }

                    htmlContent += `</ul></div>`;


                if (!(data.cafes_list && data.cafes_list.length > 0) && !(data.study_cafes_list && data.study_cafes_list.length > 0)) {
                    htmlContent += `
                        <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <h2 class="text-2xl font-semibold text-gray-800 mb-3">â˜• ì£¼ë³€ ì¥ì†Œ</h2>
                            <p class="text-gray-700">ì£¼ë³€ì— ì°¾ì„ ìˆ˜ ìˆëŠ” ì¹´í˜ë‚˜ ìŠ¤í„°ë””ì¹´í˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                    `;
                }

            } else if (data.result_type === "direct_places" && (data.direct_nearby_places_cafes.length > 0 || data.direct_nearby_places_study_cafes.length > 0)) {
                htmlContent += `
                    <div class="mb-6 p-4 bg-purple-50 rounded-lg border border-purple-200">
                        <h2 class="text-2xl font-semibold text-purple-800 mb-3">âœ¨ ì¤‘ì‹¬ ì§€ì  ì£¼ë³€ ì¥ì†Œ (ì—­/í„°ë¯¸ë„ ì—†ìŒ)</h2>
                        <p class="text-lg text-gray-700 mb-2">ìµœì ì˜ ì—­(ì§€í•˜ì² /ë²„ìŠ¤)ì„ ì°¾ì„ ìˆ˜ ì—†ì–´, ì¤‘ì‹¬ ì§€ì  ì£¼ë³€ì˜ ì¹´í˜/ìŠ¤í„°ë””ì¹´í˜ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.</p>
                `;
                // Display Direct Cafes
                if (data.direct_nearby_places_cafes && data.direct_nearby_places_cafes.length > 0) {
                    htmlContent += `
                        <h3 class="text-xl font-semibold text-green-700 mt-4 mb-2">â˜• ì£¼ë³€ ì¹´í˜ (ìƒìœ„ 5ê°œ)</h3>
                        <ul class="list-disc pl-5 space-y-2 text-gray-700">
                    `;
                    data.direct_nearby_places_cafes.forEach(cafe => {
                        htmlContent += `
                                <li>
                                    <strong>${cafe.name}</strong> (ê±°ë¦¬: ${cafe.distance_km.toFixed(2)} km)
                                    <span class="text-sm text-gray-500">(${cafe.lat.toFixed(6)}, ${cafe.lng.toFixed(6)})</span>
                                </li>
                        `;
                    });
                    htmlContent += `
                        </ul>
                    `;
                }
                
                // ğŸ“š ì£¼ë³€ ìŠ¤í„°ë””ì¹´í˜ (ìƒìœ„ 5ê°œ) â€” ë°±ì—”ë“œ API ê²°ê³¼ ì‚¬ìš©
                htmlContent += `
                <h3 class="text-xl font-semibold text-yellow-700 mt-4 mb-2">ğŸ“š ì£¼ë³€ ìŠ¤í„°ë””ì¹´í˜ (ìƒìœ„ 5ê°œ)</h3>
                <ul class="list-disc pl-5 space-y-2 text-gray-700">`;

                try {
                const cafes = await loadStudyCafesTop5({ lat: data.best_point.lat, lng: data.best_point.lng });
                if (!cafes.length) {
                    htmlContent += `<li class="text-gray-500">ì£¼ë³€ì— ìŠ¤í„°ë””ì¹´í˜ê°€ ì—†ìŠµë‹ˆë‹¤.</li>`;
                } else {
                    cafes.forEach(sc => {
                    const dkm = (typeof sc.distance_km === 'number') ? sc.distance_km.toFixed(2) : '-';
                    const la = sc.location?.lat ?? sc.lat;
                    const ln = sc.location?.lng ?? sc.lng;
                    htmlContent += `
                        <li>
                        <strong>${sc.name}</strong> (ê±°ë¦¬: ${dkm} km)
                        <span class="text-sm text-gray-500">(${la?.toFixed?.(6) ?? ''}, ${ln?.toFixed?.(6) ?? ''})</span>
                        </li>`;
                    });
                }
                } catch (e) {
                htmlContent += `<li class="text-red-600">ìŠ¤í„°ë””ì¹´í˜ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${e.message}</li>`;
                }

                htmlContent += `</ul>`;



                htmlContent += `</div>`; // Close the main div for direct_places

            } else if (data.result_type === "no_places_found") {
                htmlContent += `
                    <p class="text-red-600 text-lg font-medium text-center p-4 bg-red-50 rounded-lg border border-red-200">
                        ì£„ì†¡í•©ë‹ˆë‹¤. ì ì ˆí•œ ë¯¸íŒ… ì¥ì†Œë‚˜ ì£¼ë³€ í¸ì˜ ì‹œì„¤ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                    </p>
                `;
            } else {
                 htmlContent += `
                    <p class="text-red-600 text-lg font-medium text-center p-4 bg-red-50 rounded-lg border border-red-200">
                        ì£„ì†¡í•©ë‹ˆë‹¤. ìœ íš¨í•œ ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.
                    </p>
                `;
            }
            resultsDisplay.innerHTML = htmlContent;
            resultsDisplay.classList.remove("hidden");

            // âœ… ê²°ê³¼ íƒ€ì…ë³„ë¡œ ìµœì  ì¥ì†Œ ì¢Œí‘œë¥¼ ë½‘ì•„ ë²„íŠ¼ ì£¼ì…
let centerForCafes = null;
if (data.result_type === "transit_station" && data.best_station) {
  centerForCafes = { lat: data.best_station.lat, lng: data.best_station.lng };
} else if (data.result_type === "bus_terminal" && data.best_bus_terminal) {
  centerForCafes = { lat: data.best_bus_terminal.lat, lng: data.best_bus_terminal.lng };
} else if (data.result_type === "direct_places" && data.best_point) {
  centerForCafes = { lat: data.best_point.lat, lng: data.best_point.lng };
}

if (centerForCafes) {
  injectStudyCafeReserveButton(centerForCafes);
}

        }
        function closeAdBanner() {
            const el = document.getElementById('adBanner');
            if (el) {
            el.style.display = 'none';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°°ë„ˆ ìˆ¨ê¹€ ì—¬ë¶€ ë°˜ì˜
        document.addEventListener('DOMContentLoaded', () => {
            try {
            if (localStorage.getItem('hide_ad_banner') === '1') {
                const el = document.getElementById('adBanner');
                if (el) el.style.display = 'none';
            }
            } catch (e) {
            // private browsing ë“± localStorage ë¶ˆê°€ í™˜ê²½ ëŒ€ë¹„: ì¡°ìš©íˆ ë¬´ì‹œ
            }
        });
    </script>
    <!-- YOUR_GOOGLE_MAPS_API_KEYë¥¼ ì‹¤ì œ Google Maps API í‚¤ë¡œ êµì²´í•˜ì„¸ìš” -->
    <!-- ë°˜ë“œì‹œ Maps JavaScript API, Places API, Distance Matrix API, Directions APIê°€ í™œì„±í™”ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤. -->
     <script>
  const ROUTE_COLORS = ["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd",
                        "#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"];

  function fmtTime(ts) {
    try { return new Date(ts).toTimeString().slice(0,5); } catch(e) { return ""; }
  }

  // ì£¼ì†Œ ë³´ê¸° ì¢‹ê²Œ ì •ë¦¬
function cleanAddress(str = "") {
  return String(str)
    .replace(/^ëŒ€í•œë¯¼êµ­\s*/, "")
    .replace(/\(\d{5}\)\s*/g, "")
    .trim();
}
function vehicleEmoji(type) {
  switch (type) {
    case "SUBWAY": return "ğŸš‡";
    case "HEAVY_RAIL":
    case "COMMUTER_TRAIN":
    case "RAIL": return "ğŸš‰";
    case "BUS": return "ğŸšŒ";
    case "TRAM": return "ğŸšŠ";
    default: return "ğŸš†";
  }
}

function stepToHTML(step) {
  if (step.travel_mode === "WALKING") {
    const d = step.distance?.text ?? "";
    const t = step.duration?.text ?? "";
    return `<li class="leading-6">ğŸš¶ ë„ë³´ <span class="text-gray-700">${d}</span> Â· <span class="text-gray-700">ì•½ ${t}</span></li>`;
  }
  if (step.travel_mode === "TRANSIT") {
    // âœ… JS SDKëŠ” step.transit ì‚¬ìš© (transit_details ì•„ë‹˜)
    const td = step.transit || step.transit_details;
    if (!td) return `<li>ëŒ€ì¤‘êµí†µ êµ¬ê°„</li>`;
    const lineName = td.line?.short_name || td.line?.name || "ë…¸ì„ ";
    const vType = td.line?.vehicle?.type || "";
    const from = cleanAddress(td.departure_stop?.name || "");
    const to   = cleanAddress(td.arrival_stop?.name || "");
    const depT = td.departure_time?.text || (td.departure_time?.value ? new Date(td.departure_time.value).toTimeString().slice(0,5) : "");
    const arrT = td.arrival_time?.text || (td.arrival_time?.value ? new Date(td.arrival_time.value).toTimeString().slice(0,5) : "");
    const stops = (td.num_stops != null) ? `${td.num_stops} ì •ê±°ì¥` : "";
    const head  = td.headsign ? ` (${td.headsign})` : "";
    const bg = td.line?.color || "#eef2ff";     // ë…¸ì„  ìƒ‰ìƒ
    const fg = td.line?.text_color || "#111827";

    return `
      <li class="leading-6">
        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold"
              style="background:${bg};color:${fg};border:1px solid rgba(0,0,0,0.06);">
          ${vehicleEmoji(vType)} ${lineName}
        </span>
        <span class="ml-2">${from} â†’ ${to}${head}</span>
        <span class="ml-2 text-gray-600">${stops}</span>
        <span class="ml-2 text-gray-500">${depT}~${arrT}</span>
      </li>`;
  }
  return `<li>ê¸°íƒ€ êµ¬ê°„</li>`;
}


async function showRoutesForAll() {
  if (!selectedDestination) { alert("ë¨¼ì € ëª©ì ì§€ë¥¼ ì„ íƒ(ë¯¸íŒ…ì—­/í„°ë¯¸ë„/ì¹´í˜ í´ë¦­)í•˜ì„¸ìš”."); return; }
  if (!originCoords?.length) { alert("ì¶œë°œì§€ë¥¼ ë¨¼ì € ì¶”ê°€í•˜ì„¸ìš”."); return; }

  // ê¸°ì¡´ ê²½ë¡œ ë Œë”ëŸ¬ ì œê±°
  directionsRenderers.forEach(r => r.setMap(null));
  directionsRenderers = [];

  const prefRaw = document.getElementById("routePreference").value;
  const routingPreference =
    (prefRaw === "LESS_WALKING")
      ? google.maps.TransitRoutePreference.LESS_WALKING
      : google.maps.TransitRoutePreference.FEWER_TRANSFERS;

  const panel = document.getElementById("routesPanel");
  panel.classList.remove("hidden");
  panel.innerHTML = "";

  // ì¶œë°œì§€ë³„ë¡œ ë¹„ë™ê¸° ìš”ì²­ + ì¹´ë“œ ìƒì„±
  const tasks = originCoords.map((orig, idx) => new Promise((resolve) => {
    directionsService.route({
      origin: new google.maps.LatLng(orig.lat, orig.lng),
      destination: new google.maps.LatLng(selectedDestination.lat, selectedDestination.lng),
      travelMode: google.maps.TravelMode.TRANSIT,
      transitOptions: { routingPreference, departureTime: new Date() },
      provideRouteAlternatives: false,
      region: "KR"
    }, (result, status) => {
      const card = document.createElement("div");
      card.className = "mb-4 p-4 rounded-lg border bg-white shadow-sm";

      if (status !== google.maps.DirectionsStatus.OK || !result?.routes?.length) {
        card.innerHTML = `<div class="font-semibold">ì¶œë°œì§€ ${idx+1}</div>
                          <div class="text-red-600">ê²½ë¡œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>`;
        panel.appendChild(card);
        return resolve();
      }

      const route = result.routes[0];
      const leg   = route.legs?.[0];
      const startLabel   = cleanAddress(leg?.start_address || `ì¶œë°œì§€ ${idx+1}`);
      const steps        = leg?.steps ?? [];
      const durationText = leg?.duration?.text ?? "-";
      const arrival      = leg?.arrival_time?.text || fmtTime(leg?.arrival_time?.value) || "-";
      const departure    = leg?.departure_time?.text || fmtTime(leg?.departure_time?.value) || "-";
      const transfers    = Math.max(0, steps.filter(s => s.travel_mode === "TRANSIT").length - 1);

      // ì§€ë„ ê²½ë¡œ(ì‚¬ëŒë§ˆë‹¤ ë‹¤ë¥¸ ìƒ‰)
      const renderer = new google.maps.DirectionsRenderer({
        map,
        directions: result,
        suppressMarkers: false,
        preserveViewport: true,
        polylineOptions: { strokeColor: ROUTE_COLORS[idx % ROUTE_COLORS.length], strokeOpacity: 0.8, strokeWeight: 5 }
      });
      directionsRenderers.push(renderer);

      // ì¹´ë“œ HTML
      card.innerHTML = `
        <div class="flex items-baseline justify-between mb-2">
          <div class="font-semibold text-gray-900">ì¶œë°œì§€ ${idx+1} Â· <span class="text-gray-700">${startLabel}</span></div>
          <div class="text-sm text-gray-500">ì¶œë°œ ${departure} â†’ ë„ì°© ${arrival}</div>
        </div>
        <div class="mb-2">
          <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-blue-50 text-blue-700 border border-blue-100">
            ì´ ${durationText}
          </span>
          <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-indigo-50 text-indigo-700 border border-indigo-100 ml-1">
            í™˜ìŠ¹ ${transfers}íšŒ
          </span>
        </div>
        <ol class="mt-2 space-y-1 text-gray-800 list-decimal pl-5">
          ${steps.map(stepToHTML).join("")}
        </ol>
        <div class="mt-3 text-right">
            <button class="detail-btn px-3 py-1.5 rounded-md bg-black hover:bg-black/90 text-white
               focus:outline-none focus:ring-2 focus:ring-black"
            data-origin-lat="${orig.lat}"
            data-origin-lng="${orig.lng}"
            data-dest-lat="${selectedDestination.lat}"
            data-dest-lng="${selectedDestination.lng}"
            data-pref="${prefRaw}">
            ìì„¸íˆ ë³´ê¸°
          </button>
        </div>
      `;
      panel.appendChild(card);

      // ìƒì„¸ í˜ì´ì§€ ì´ë™
      card.querySelector(".detail-btn").addEventListener("click", (ev) => {
        const b = ev.currentTarget;
        saveState();
        const url = `/route?origin=${b.dataset.originLat},${b.dataset.originLng}`
                  + `&dest=${b.dataset.destLat},${b.dataset.destLng}`
                  + `&pref=${b.dataset.pref}`
                  + `&depart=${Date.now()}`;
        window.location.href = url;
      });

      resolve();
    });
  }));

  await Promise.all(tasks);
}


  // ë²„íŠ¼ í´ë¦­ ì—°ê²°
  document.getElementById("btnShowRoutes")?.addEventListener("click", (e) => {
    e.preventDefault();
    showRoutesForAll();
  });
// ìŠ¤í„°ë””ì¹´í˜ ëª©ë¡ í˜ì´ì§€ë¡œ ì´ë™
function gotoStudyCafeList() {
  try {
    const c = map?.getCenter?.();
    const lat = c ? c.lat() : (window.lastCenter?.lat || 37.5665);
    const lng = c ? c.lng() : (window.lastCenter?.lng || 126.9780);
    const radius = 3000; // í•„ìš”ì‹œ ì¡°ì ˆ
    location.href = `/studycafes?lat=${lat}&lng=${lng}&radius=${radius}`;
  } catch (e) {
    location.href = `/studycafes`; // í´ë°±
  }
}
document.getElementById("btnStudyCafeList")?.addEventListener("click", gotoStudyCafeList);


// âœ… ìµœì  ì¥ì†Œ(centerLatLng) ê¸°ì¤€ìœ¼ë¡œ, actionBar ì•ˆì—ì„œ "ì‚¬ëŒë³„ ê²½ë¡œ ìƒì„¸ ë³´ê¸°" ë²„íŠ¼ ìœ„ì—
//    "ìŠ¤í„°ë””ì¹´í˜ ì˜ˆì•½í•˜ê¸°" ë²„íŠ¼ì„ ì£¼ì…í•˜ëŠ” ìœ í‹¸
function injectStudyCafeReserveButton(centerLatLng) {
  // ì¤‘ë³µ ìƒì„± ë°©ì§€
  document.getElementById('btnStudyCafeListInline')?.remove();

  const bar = document.getElementById('actionBar');
  const personBtn = document.getElementById('btnShowRoutes');
  if (!bar || !personBtn) return;

  const btn = document.createElement('button');
  btn.id = 'btnStudyCafeListInline';
  btn.type = 'button';
  btn.className = 'w-full mb-2 px-3 py-2 rounded-lg bg-white text-[#0D72C6] border border-[#35AAF2] font-bold hover:bg-[#E9F6FF]';
  btn.textContent = 'ìŠ¤í„°ë””ì¹´í˜ ì˜ˆì•½';

  // í´ë¦­ â†’ ì£¼ë³€(1.5km) ìŠ¤í„°ë””ì¹´í˜ ì „ìš© í˜ì´ì§€ë¡œ
  const lat = typeof centerLatLng.lat === 'function' ? centerLatLng.lat() : centerLatLng.lat;
  const lng = typeof centerLatLng.lng === 'function' ? centerLatLng.lng() : centerLatLng.lng;
  btn.addEventListener('click', () => {
    const radius = 1500; // "ì£¼ë³€"ë§Œ ë³´ì´ë„ë¡ 1.5km
    location.href = `/studycafes?lat=${lat}&lng=${lng}&radius=${radius}`;
  });

  // âœ” actionBar ì•ˆì—ì„œ "ì‚¬ëŒë³„ ê²½ë¡œ ìƒì„¸ ë³´ê¸°" ë²„íŠ¼ ë°”ë¡œ ìœ„ì— ì‚½ì…
  bar.insertBefore(btn, personBtn);
}

</script>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCGgZQhmNH8ooriI05CeOi60AvlOcYTHPQ&libraries=places&callback=initMap"></script>
</body>
</html>
