<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ê²½ë¡œ ìƒì„¸ ë³´ê¸° | Where2Meet</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', sans-serif; background:#f8fafc; }
    #map { height: 100%; width: 100%; }
    /* ì‹œê°„ë°” */
    .timebar { display:flex; height: 14px; border:1px solid #e5e7eb; border-radius:9999px; overflow:hidden; background:#f3f4f6; }
    .timebar-seg { height:100%; position:relative; }
    .timebar-seg:hover::after { content: attr(data-label); position:absolute; top:-30px; left:50%; transform:translateX(-50%); font-size:11px; background:#111827; color:#fff; padding:2px 6px; border-radius:6px; white-space:nowrap; }
    /* ìŠ¤í… í•˜ì´ë¼ì´íŠ¸ */
    .step-btn { width:100%; text-align:left; padding:8px 10px; border-radius:10px; }
    .step-btn:hover { background:#f3f4f6; }
  </style>
</head>
<body class="min-h-screen">
  <!-- Top bar -->
  <header class="sticky top-0 z-10 bg-white/90 backdrop-blur border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <a href="/" class="text-gray-600 hover:text-gray-900">â† ëŒì•„ê°€ê¸°</a>
      <h1 class="text-lg sm:text-xl font-semibold text-gray-900">ì‚¬ëŒë³„ ê²½ë¡œ ìƒì„¸</h1>
      <div class="ml-auto flex items-center gap-3">
        <label class="inline-flex items-center gap-1 text-sm text-gray-700">
          <input id="toggleMarkers" type="checkbox" class="accent-indigo-600" checked /> í™˜ìŠ¹/ì •ì°¨ ë§ˆì»¤ í‘œì‹œ
        </label>
        <select id="pref" class="border rounded px-2 py-1 text-sm">
          <option value="FEWER_TRANSFERS">í™˜ìŠ¹ ì ê²Œ</option>
          <option value="LESS_WALKING">ë„ë³´ ì ê²Œ</option>
        </select>
        <a id="openGmaps" target="_blank" class="text-sm text-indigo-600 hover:underline">Google ì§€ë„ì—ì„œ ì—´ê¸°</a>
      </div>
    </div>
  </header>

  <!-- Layout -->
  <main class="max-w-6xl mx-auto px-4 py-4 grid grid-cols-1 lg:grid-cols-[440px,1fr] gap-4">
    <!-- Left: timeline -->
    <section class="bg-white border rounded-2xl shadow-sm p-4 h-max">
      <div class="mb-3">
        <div class="text-sm text-gray-500" id="startEnd"></div>
        <div class="mt-1 text-2xl font-bold text-gray-900" id="summaryDuration">ì´ 0ë¶„</div>
        <div class="mt-2 flex flex-wrap gap-2">
          <span id="sumWalking" class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-blue-50 text-blue-700 border border-blue-100">ë„ë³´ 0ë¶„</span>
          <span id="sumTransfers" class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-indigo-50 text-indigo-700 border border-indigo-100">í™˜ìŠ¹ 0íšŒ</span>
        </div>
      </div>

      <!-- ì‹œê°„ ë¶„í¬ ë°” -->
      <div class="mt-3">
        <div class="flex items-center justify-between mb-1">
          <div class="text-sm font-semibold text-gray-800">ì‹œê°„ ë¶„í¬</div>
          <div class="flex items-center gap-3 text-xs text-gray-600">
            <span class="inline-flex items-center gap-1"><span class="w-3 h-3 inline-block rounded bg-gray-400"></span>ë„ë³´</span>
            <span class="inline-flex items-center gap-1"><span class="w-3 h-3 inline-block rounded bg-indigo-500"></span>ëŒ€ì¤‘êµí†µ</span>
          </div>
        </div>
        <div id="timebar" class="timebar"></div>
      </div>

      <!-- ë‹¨ê³„ ëª©ë¡ -->
      <ol id="steps" class="mt-4 space-y-2 text-gray-900"></ol>
      <div id="fatalBox" class="hidden mt-4 p-3 rounded-lg border bg-red-50 text-red-700 text-sm"></div>
    </section>

    <!-- Right: map -->
    <section class="bg-white border rounded-2xl shadow-sm overflow-hidden min-h-[60vh] lg:min-h-[72vh]">
      <div id="map"></div>
      <!-- ë²”ë¡€ -->
      <div class="absolute bottom-3 right-3 bg-white/95 border rounded-xl shadow px-3 py-2 text-xs text-gray-700 flex flex-col gap-1">
        <div class="flex items-center gap-2"><span class="w-4 h-1.5 inline-block rounded bg-gray-400"></span>ë„ë³´(ì ì„ )</div>
        <div class="flex items-center gap-2"><span class="w-4 h-1.5 inline-block rounded bg-indigo-500"></span>ëŒ€ì¤‘êµí†µ</div>
        <div class="flex items-center gap-2"><img alt="" class="w-3 h-3" src="https://maps.google.com/mapfiles/ms/icons/blue-dot.png"/> ìŠ¹ì°¨</div>
        <div class="flex items-center gap-2"><img alt="" class="w-3 h-3" src="https://maps.google.com/mapfiles/ms/icons/yellow-dot.png"/> í™˜ìŠ¹</div>
        <div class="flex items-center gap-2"><img alt="" class="w-3 h-3" src="https://maps.google.com/mapfiles/ms/icons/green-dot.png"/> í•˜ì°¨</div>
      </div>
    </section>
  </main>

  <script>
    // ì¸ì¦ ì‹¤íŒ¨ ë©”ì‹œì§€
    window.gm_authFailure = function () {
      const box = document.getElementById('fatalBox');
      box.classList.remove('hidden');
      box.innerHTML = '<div class="font-semibold mb-1">Google Maps ì¸ì¦ ì‹¤íŒ¨</div><div class="text-red-800">API í‚¤ ë˜ëŠ” ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.</div>';
    };

    function getParams() {
      const sp = new URLSearchParams(location.search);
      const [olat, olng] = (sp.get('origin')||'').split(',').map(Number);
      const [dlat, dlng] = (sp.get('dest')||'').split(',').map(Number);
      return { origin:{lat:olat,lng:olng}, dest:{lat:dlat,lng:dlng}, pref: sp.get('pref')||'FEWER_TRANSFERS', depart: new Date(parseInt(sp.get('depart')||Date.now(),10)) };
    }
    function vehicleEmoji(type){ switch(type){ case 'SUBWAY': return 'ğŸš‡'; case 'HEAVY_RAIL': case 'COMMUTER_TRAIN': case 'RAIL': return 'ğŸš‰'; case 'BUS': return 'ğŸšŒ'; case 'TRAM': return 'ğŸšŠ'; default: return 'ğŸš†'; } }
    function cleanAddress(str=''){ return String(str).replace(/^ëŒ€í•œë¯¼êµ­\s*/, '').replace(/\(\d{5}\)\s*/g,'').trim(); }
    function fmtTime(ts){ try{ return new Date(ts).toTimeString().slice(0,5);}catch(e){return'';} }

    // ì§€ë„ ë¦¬ì†ŒìŠ¤ë“¤
    let map, directionsService, directionsRenderer;
    let segmentPolylines = []; // ìŠ¤í…ë³„ í´ë¦¬ë¼ì¸
    let stepMarkers = [];      // í™˜ìŠ¹/ìŠ¹í•˜ì°¨ ë§ˆì»¤

    function clearOverlays(){
      segmentPolylines.forEach(p=>p.setMap(null)); segmentPolylines=[];
      stepMarkers.forEach(m=>m.setMap(null)); stepMarkers=[];
    }

    function addMarker(pos, iconUrl, title){
      const m = new google.maps.Marker({ position: pos, map, icon:{ url: iconUrl }, title });
      stepMarkers.push(m); return m;
    }

    function makeDashedPolyline(path){
      const lineSymbol = { path: 'M 0,-1 0,1', strokeOpacity: 1, scale: 2 };
      const pl = new google.maps.Polyline({ path, strokeOpacity:0, icons:[{ icon: lineSymbol, offset:'0', repeat:'10px' }], strokeColor:'#9CA3AF', map });
      segmentPolylines.push(pl); return pl;
    }

    function makeSolidPolyline(path, color){
      const pl = new google.maps.Polyline({ path, strokeColor: color||'#4f46e5', strokeOpacity:0.9, strokeWeight:6, map });
      segmentPolylines.push(pl); return pl;
    }

    function stepToHTML(step, idx, color) {
  if (step.travel_mode === 'WALKING') {
    const d = step.distance?.text ?? '';
    const t = step.duration?.text ?? '';
    return `<li><button class="step-btn" data-step="${idx}">
      ğŸš¶ ë„ë³´ Â· <span class="text-gray-700">${d}</span> Â· ì•½ <span class="text-gray-700">${t}</span>
    </button></li>`;
  }

  if (step.travel_mode === 'TRANSIT') {
    const td   = step.transit || step.transit_details;
    if (!td) return `<li><button class="step-btn" data-step="${idx}">ëŒ€ì¤‘êµí†µ êµ¬ê°„</button></li>`;

    const lineName = td.line?.short_name || td.line?.name || 'ë…¸ì„ ';
    const vType    = td.line?.vehicle?.type || '';
    const from     = cleanAddress(td.departure_stop?.name || '');
    const to       = cleanAddress(td.arrival_stop?.name   || '');
    const depT     = td.departure_time?.text || fmtTime(td.departure_time?.value);
    const arrT     = td.arrival_time?.text   || fmtTime(td.arrival_time?.value);
    const stops    = (td.num_stops != null) ? `${td.num_stops} ì •ê±°ì¥` : '';
    const head     = td.headsign ? ` (${td.headsign})` : '';
    const bg       = color || td.line?.color || '#eef2ff';
    const fg       = td.line?.text_color || '#111827';
    const durText  = step.duration?.text || '';   // âœ… ì´ ì¤„ ì¶”ê°€ (êµ¬ê°„ ì†Œìš”ì‹œê°„)

    return `<li><button class="step-btn" data-step="${idx}">
      ${vehicleEmoji(vType)}
      <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold"
            style="background:${bg};color:${fg};border:1px solid rgba(0,0,0,0.06);">${lineName}</span>
      <span class="ml-2">${from} â†’ ${to}${head}</span>
      <span class="ml-2 text-gray-600">${stops}</span>
      <span class="ml-2 text-gray-500">${depT}~${arrT}</span>
      ${durText ? `<span class="ml-2 text-gray-800">Â· ì•½ ${durText}</span>` : ``}  <!-- âœ… ì—¬ê¸° í‘œì‹œ -->
    </button></li>`;
  }

  return `<li><button class="step-btn" data-step="${idx}">ê¸°íƒ€ êµ¬ê°„</button></li>`;
}


    function secondsToMinText(sec=0){ const m=Math.round(sec/60); return `${m}ë¶„`; }

    function renderTimebar(steps){
      const total = steps.reduce((s,st)=> s + (st.duration?.value||0), 0) || 1;
      const bar = document.getElementById('timebar');
      bar.innerHTML = '';
      steps.forEach((st,i)=>{
        const dur = st.duration?.value || 0; const w = (dur/total*100).toFixed(2)+'%';
        const label = (st.travel_mode==='WALKING' ? 'ë„ë³´' : 'ëŒ€ì¤‘êµí†µ') + ` Â· ${secondsToMinText(dur)}`;
        const el = document.createElement('div');
        el.className = 'timebar-seg';
        el.dataset.label = label;
        el.style.width = w;
        el.style.background = (st.travel_mode==='WALKING') ? '#9CA3AF' : (st.transit?.line?.color || '#6366F1');
        bar.appendChild(el);
      });
    }

    function highlightStep(idx){
      segmentPolylines.forEach((pl,j)=>{ pl.setOptions({ strokeWeight: (j===idx? 8 : (pl.strokeOpacity===0?0:6)), zIndex: (j===idx? 10:1) }); });
      const p = segmentPolylines[idx];
      if(p){ const path = p.getPath(); const mid = path.getAt(Math.floor(path.getLength()/2)); map.panTo(mid); map.setZoom(Math.max(map.getZoom(), 13)); }
    }

    async function drawRoute(){
      clearOverlays();

      const p = getParams();
      document.getElementById('pref').value = p.pref;
      const routingPreference = (p.pref==='LESS_WALKING')? google.maps.TransitRoutePreference.LESS_WALKING : google.maps.TransitRoutePreference.FEWER_TRANSFERS;
      const req = { origin:new google.maps.LatLng(p.origin.lat,p.origin.lng), destination:new google.maps.LatLng(p.dest.lat,p.dest.lng), travelMode:google.maps.TravelMode.TRANSIT, transitOptions:{ routingPreference, departureTime:p.depart }, provideRouteAlternatives:false, region:'KR' };

      directionsService.route(req, (result,status)=>{
        if(status!==google.maps.DirectionsStatus.OK || !result?.routes?.length){
          const box=document.getElementById('fatalBox'); box.classList.remove('hidden'); box.textContent='ê²½ë¡œë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'; return;
        }
        const route = result.routes[0];
        const leg   = route.legs?.[0];
        directionsRenderer.setDirections(result);

        // Summary
        const dep=leg?.departure_time?.text||fmtTime(leg?.departure_time?.value)||'-';
        const arr=leg?.arrival_time?.text||fmtTime(leg?.arrival_time?.value)||'-';
        document.getElementById('startEnd').textContent=`ì¶œë°œ ${dep} â†’ ë„ì°© ${arr}`;
        document.getElementById('summaryDuration').textContent=`ì´ ${leg?.duration?.text||'-'}`;

        // Build overlays per step
        const steps=leg?.steps??[];
        const list=document.getElementById('steps'); list.innerHTML='';
        renderTimebar(steps);

        let walkingSec=0; let transfers=0;
        steps.forEach((s,idx)=>{
          // Polyline
          if(s.travel_mode==='WALKING'){
            const pl = makeDashedPolyline(s.path);
            walkingSec += (s.duration?.value||0);
          } else if(s.travel_mode==='TRANSIT'){
            transfers += 1;
            const td = s.transit || s.transit_details || {};
            const color = td.line?.color || '#4f46e5';
            const pl = makeSolidPolyline(s.path, color);
            // ìŠ¹ì°¨/í™˜ìŠ¹/í•˜ì°¨ ë§ˆì»¤
            if(td.departure_stop?.location){ addMarker(td.departure_stop.location, 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png', 'ìŠ¹ì°¨'); }
            // ë‹¤ìŒ ìŠ¤í…ë„ TRANSITì´ë©´ ì´ë²ˆ ë„ì°©=í™˜ìŠ¹ ì§€ì 
            const next = steps[idx+1];
            if(td.arrival_stop?.location){
              if(next && next.travel_mode==='TRANSIT') addMarker(td.arrival_stop.location, 'https://maps.google.com/mapfiles/ms/icons/yellow-dot.png', 'í™˜ìŠ¹');
              else addMarker(td.arrival_stop.location, 'https://maps.google.com/mapfiles/ms/icons/green-dot.png', 'í•˜ì°¨');
            }
          }
          // ëª©ë¡ HTML
          const td = s.transit || s.transit_details || {}; const color = td.line?.color || '#eef2ff';
          list.insertAdjacentHTML('beforeend', stepToHTML(s, idx, color));
        });
        document.getElementById('sumWalking').textContent = `ë„ë³´ ${secondsToMinText(walkingSec)}`;
        document.getElementById('sumTransfers').textContent = `í™˜ìŠ¹ ${Math.max(0, transfers-1)}íšŒ`;

        // step í´ë¦­ â†’ í•˜ì´ë¼ì´íŠ¸
        list.querySelectorAll('.step-btn').forEach(btn=>{
          btn.addEventListener('click', ()=>{ const i=Number(btn.dataset.step); highlightStep(i); });
        });

        // ë§ˆì»¤ í† ê¸€
        document.getElementById('toggleMarkers').addEventListener('change', (e)=>{
          stepMarkers.forEach(m=> m.setMap(e.target.checked? map : null));
        });

        // ë”¥ë§í¬
        const g = `https://www.google.com/maps/dir/?api=1&origin=${p.origin.lat},${p.origin.lng}&destination=${p.dest.lat},${p.dest.lng}&travelmode=transit`;
        document.getElementById('openGmaps').href = g;
      });
    }

    function initMap(){
      const p = getParams();
      map = new google.maps.Map(document.getElementById('map'), { center:{ lat:(p.origin.lat+p.dest.lat)/2, lng:(p.origin.lng+p.dest.lng)/2 }, zoom:12, gestureHandling:'greedy' });
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ map, suppressMarkers:false, preserveViewport:false });
      drawRoute();

      document.getElementById('pref').addEventListener('change', (e)=>{
        const sp = new URLSearchParams(location.search); sp.set('pref', e.target.value); history.replaceState(null, '', `${location.pathname}?${sp.toString()}`); drawRoute();
      });

      // íŒŒë¼ë¯¸í„° self-test
      const params=getParams();
      console.assert(!isNaN(params.origin.lat) && !isNaN(params.origin.lng), 'origin should be numbers');
      console.assert(!isNaN(params.dest.lat)   && !isNaN(params.dest.lng),   'dest should be numbers');
    }
  </script>

  <!-- âœ… ì‹¤ì œ í‚¤ë¡œ êµì²´í•˜ì„¸ìš” -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCGgZQhmNH8ooriI05CeOi60AvlOcYTHPQ&libraries=places&callback=initMap"></script>
</body>
</html>